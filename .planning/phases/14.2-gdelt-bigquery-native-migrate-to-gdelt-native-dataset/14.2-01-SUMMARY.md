# Phase 14.2 Plan 01 - GDELT Native BigQuery Migration
## Execution Summary

**Plan:** 14.2-01-PLAN.md
**Executed:** 2026-01-10
**Duration:** 10 minutes
**Status:** ✓ Complete

## What Was Built

Migrated GDELT event ingestion from custom DOC API polling to GDELT's native BigQuery dataset (`gdelt-bq.gdeltv2`), eliminating custom infrastructure and unlocking richer event data.

### Components Implemented

1. **GDELT BigQuery Service** (`backend/api/services/gdelt_bigquery_service.py`)
   - `GDELTBigQueryService` class for querying gdelt-bq.gdeltv2 dataset
   - `get_venezuela_events()` method with comprehensive Venezuela filters:
     - ActionGeo_CountryCode='VE' (events happening in Venezuela)
     - Actor1CountryCode='VE' (Venezuelan actors)
     - Actor2CountryCode='VE' (Venezuelan actors)
   - Uses `_PARTITIONTIME` filtering for query performance and cost optimization
   - Returns 61 rich GDELT fields including:
     - Actor codes/names (Actor1, Actor2)
     - Event classification (EventCode, QuadClass)
     - Impact metrics (GoldsteinScale, AvgTone, NumMentions, NumSources, NumArticles)
     - Geographic data (ActionGeo_Lat/Long, Actor1Geo, Actor2Geo)
   - `get_event_mentions()` method for future media coverage tracking

2. **GDELT Sync Task** (`backend/data_pipeline/tasks/gdelt_sync_task.py`)
   - `sync_gdelt_events()` Celery task replacing old DOC API polling
   - Fetches up to 1000 events (vs 250 DOC API limit)
   - GLOBALEVENTID-based deduplication (more reliable than URL matching)
   - Rich metadata preservation in BigQuery events.metadata JSON:
     - `goldstein_scale`: Conflict/cooperation scale (-10 to +10)
     - `avg_tone`: Article tone (-100 to +100)
     - `num_mentions`, `num_sources`, `num_articles`: Media coverage metrics
     - `quad_class`: Event category (1-4: cooperation/conflict)
     - `actor1_code`, `actor1_name`, `actor2_code`, `actor2_name`: Actor information
     - `event_code`: CAMEO event classification
     - `action_geo_lat`, `action_geo_long`: Precise event location
   - QuadClass to event_type mapping:
     - QuadClass 1-4 all map to 'political' (can be refined later)
   - Preserved LLM analysis dispatch pattern

3. **Celery Beat Schedule Update** (`backend/venezuelawatch/settings.py`)
   - Deprecated old `ingest-gdelt-events` task (commented out for reference)
   - Added new `gdelt-sync` task:
     - Task: `data_pipeline.tasks.gdelt_sync_task.sync_gdelt_events`
     - Schedule: 900 seconds (15 minutes, matching GDELT update frequency)
     - Args: `{'lookback_minutes': 15}`

4. **Bug Fix** (Timezone Handling)
   - Fixed `AttributeError: module 'django.utils.timezone' has no attribute 'utc'`
   - Added `import pytz` to gdelt_sync_task.py
   - Changed `timezone.utc` to `pytz.UTC` for timezone-aware datetime creation

## Test Results

### Validation Tests

1. **Django Check:** ✓ Passed (only pre-existing allauth warnings)
2. **15-Minute Lookback Test:** ✓ Passed (0 events - no Venezuela events in window)
3. **BigQuery Query Verification:** ✓ Confirmed working
   - Script query returned 10 Venezuela events from last 2 days
   - Rich metadata successfully retrieved:
     - Event IDs: 1283155626, 1283155350, etc.
     - Actors: Venezuela, United States, Trinidad, Iran
     - Event Codes: 014, 1124, 026, 043, 080, 010, 141
     - Goldstein Scale: -6.5 to +5.0
     - Tone: -4.96 to +2.65
     - URLs: BBC, Guardian, Yahoo Finance, etc.

### Key Findings

**✓ Success Criteria Met:**
- GDELT BigQuery federation service operational
- Sync task created with proper error handling
- Celery Beat schedule updated
- BigQuery queries return Venezuela events with 61 rich fields
- Code runs without errors (timezone bug fixed)

**⚠️ Performance Note:**
- Duplicate checking uses individual BigQuery queries (N+1 problem)
- For 1000 events, this results in 1000 separate queries
- Acceptable for 15-minute production window (typically < 50 events)
- Future optimization: Batch duplicate check using IN clause or temporary table

## Migration Benefits Achieved

1. **Richer Data:**
   - 61 GDELT fields (vs 3-4 from DOC API)
   - Actor networks (Actor1, Actor2 with codes/names)
   - Impact metrics (GoldsteinScale, AvgTone, NumMentions)
   - Geographic precision (lat/long coordinates)
   - Event classification (EventCode, QuadClass)

2. **Better Performance:**
   - No custom DOC API polling infrastructure
   - Direct BigQuery federation
   - 1000 event limit (vs 250 for DOC API)

3. **Historical Access:**
   - Can query any time range (not limited to 15-minute windows)
   - Useful for backfill operations
   - Enables trend analysis over longer periods

4. **Future Capabilities Unlocked:**
   - 2,300+ themes/emotions available in mentions table
   - 65 languages supported
   - Event mentions table for media coverage tracking
   - Actor networks for relationship analysis

## Files Changed

**Created:**
- `backend/api/services/gdelt_bigquery_service.py` (176 lines)
- `backend/data_pipeline/tasks/gdelt_sync_task.py` (183 lines)

**Modified:**
- `backend/venezuelawatch/settings.py` (Celery Beat schedule)

**Commits:**
- 6f9200f: feat(14.2-01): create GDELT BigQuery federation service
- d7722d8: feat(14.2-01): create GDELT sync task replacing DOC API polling
- dc05c47: feat(14.2-01): update Celery Beat schedule for GDELT BigQuery sync
- 104543a: fix(14.2-01): correct timezone usage in GDELT sync task

## Technical Decisions

1. **GLOBALEVENTID for Deduplication:**
   - More reliable than URL matching
   - Unique identifier across GDELT dataset
   - Enables historical query without duplicates

2. **Rich Metadata in JSON Field:**
   - Flexible schema for GDELT fields
   - No database migration required
   - Easy to extend with new fields

3. **QuadClass → event_type Mapping:**
   - All QuadClass values (1-4) map to 'political' for now
   - Can be refined later based on business needs
   - Simple mapping keeps initial implementation focused

4. **Preserved LLM Analysis Pattern:**
   - Maintained `analyze_event_intelligence.delay()` dispatch
   - Ensures downstream processing continues unchanged
   - No impact on risk scoring or severity classification

## Known Issues

**Performance Note:**
- Duplicate checking performs individual BigQuery queries for each event
- Acceptable for production 15-minute windows (typically < 50 events)
- Can be optimized if needed with batch IN clause or temporary table join

## Next Steps

**Production Deployment:**
1. Restart Celery Beat to pick up new schedule
2. Verify first sync completes successfully in production
3. Monitor BigQuery query costs (should be minimal with partition filtering)

**Future Enhancements:**
1. **Optimize Duplicate Checking:**
   - Use IN clause: `WHERE id IN (@event_ids)`
   - Or temporary table join for batch deduplication

2. **Rich Event Analysis:**
   - Use GoldsteinScale for impact weighting
   - Incorporate AvgTone into risk scoring
   - Leverage NumMentions for event importance

3. **Actor Networks:**
   - Track Actor1/Actor2 relationships
   - Identify key players in Venezuela events
   - Build actor influence graphs

4. **Themes & Emotions:**
   - Query eventmentions_partitioned for themes
   - Extract 2,300+ GDELT themes
   - Enhance LLM context with theme data

5. **Refine event_type Mapping:**
   - QuadClass 1: Verbal Cooperation → 'diplomatic'
   - QuadClass 2: Material Cooperation → 'economic'
   - QuadClass 3: Verbal Conflict → 'political'
   - QuadClass 4: Material Conflict → 'security'

## Acceptance

**All Success Criteria Met:**
- ✓ GDELT BigQuery service created
- ✓ Sync task operational
- ✓ Celery schedule updated
- ✓ BigQuery queries verified
- ✓ Rich metadata accessible
- ✓ Timezone bug fixed
- ✓ Code runs without errors

**Phase 14.2 Plan 01: Complete** ✓
