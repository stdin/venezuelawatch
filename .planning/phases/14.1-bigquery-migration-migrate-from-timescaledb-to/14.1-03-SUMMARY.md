---
phase: 14.1-bigquery-migration
plan: 03
subsystem: api-views
tags: [bigquery, django-ninja, rest-api, trending, entity-profile, chat-tools]

# Dependency graph
requires:
  - phase: 14.1-bigquery-migration
    provides: BigQuery infrastructure, service layer, and ingestion tasks
provides:
  - All API endpoints serving BigQuery data (events, entities, risk, chat)
  - Redis trending deprecated in favor of BigQuery
  - AI chat tools querying BigQuery
affects: [14.1-04-data-migration]

# Tech tracking
tech-stack:
  removed: [redis-trending]
  patterns: [bigquery-api-integration, polyglot-query-pattern]

key-files:
  created: []
  modified: [backend/api/services/bigquery_service.py, backend/data_pipeline/api.py, backend/chat/tools.py]

key-decisions:
  - "Redis trending deprecated - BigQuery handles trending with time-decay formula (simpler architecture)"
  - "Event search uses BigQuery LIKE (not full-text search) for simplicity"
  - "Response format preserved as dicts (not Django model instances) for BigQuery compatibility"
  - "Entity metadata still in PostgreSQL (reference data, not time-series)"
  - "Sanctions status still in PostgreSQL (not migrated to BigQuery yet)"
  - "trending_rank removed from entity profile (Redis deprecated, avoid extra BigQuery query)"

patterns-established:
  - "Pattern 1: BigQuery for time-series queries, PostgreSQL for reference data (polyglot persistence)"
  - "Pattern 2: Bulk Entity fetch after BigQuery trending queries to avoid N+1 problem"
  - "Pattern 3: Post-filter in Python when BigQuery query doesn't support filter (e.g., comma-separated severity)"

issues-created: []

# Metrics
duration: 25min
completed: 2026-01-10
---

# Phase 14.1 Plan 03: API Views Migration Summary

**API layer migrated: All endpoints serving BigQuery data, Redis trending deprecated, chat tools integrated.**

## Performance

- **Duration:** 25 min
- **Started:** 2026-01-10T02:26:48Z
- **Completed:** 2026-01-10T02:51:30Z
- **Tasks:** 4
- **Files modified:** 3

## Accomplishments

- Migrated 6 API endpoints to query BigQuery instead of PostgreSQL (events, trending, profile, timeline, trends)
- Added 5 BigQuery service methods: get_event_by_id, get_entity_events, get_entity_stats, search_events, enhanced get_recent_events with filters
- Deprecated Redis Sorted Sets trending in favor of BigQuery exponential time-decay queries (simpler architecture)
- Updated all 4 AI chat tools to query BigQuery: search_events, get_entity_profile, get_trending_entities, analyze_risk_trends
- Preserved response formats for frontend compatibility (dict-based serialization)
- Entity metadata still fetched from PostgreSQL (reference data vs time-series data)
- Sanctions status still queried from PostgreSQL (not migrated to BigQuery yet)

## Task Commits

Each task was committed atomically:

1. **Task 1: Update events list and detail endpoints** - `2481e3c` (feat)
2. **Task 2: Update entity trending endpoint** - `4798bdb` (feat)
3. **Task 3: Update entity profile and risk trends endpoints** - `e15ee15` (feat)
4. **Task 4: Update AI chat tool functions** - `75cfc32` (feat)

**Plan metadata:** (to be committed)

## Files Created/Modified

- `backend/api/services/bigquery_service.py` - Added 5 query methods (get_event_by_id, get_entity_events, get_entity_stats, search_events, enhanced get_recent_events)
- `backend/data_pipeline/api.py` - Updated 6 endpoints (events, trending, profile, timeline, trends) to use BigQueryService
- `backend/chat/tools.py` - Updated 4 AI chat tools for BigQuery, removed TrendingService dependency

## Decisions Made

- **Redis trending deprecated** - BigQuery handles trending efficiently with partitioning and time-decay formula; simpler architecture with single source of truth
- **Time-decay formula preserved** - 7-day half-life exponential decay implemented in BigQuery SQL (matches Phase 6 design)
- **Entity metadata in PostgreSQL** - Reference data (canonical_name, entity_type, aliases) stays in PostgreSQL, time-series data (mentions, events) in BigQuery
- **Text search with LIKE** - BigQuery LIKE operator for text search (not full-text search) for simplicity and compatibility
- **Response serialization as dicts** - BigQuery results returned as dicts (not Django model instances) for frontend compatibility
- **trending_rank removed** - Removed from entity profile to avoid extra BigQuery query (Redis deprecated)

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None

## Next Phase Readiness

✓ All event endpoints query BigQuery (list, detail, search)
✓ Entity trending uses BigQuery (Redis deprecated)
✓ Entity profile shows BigQuery events and stats
✓ Risk trends endpoint returns time-series data from BigQuery
✓ AI chat tools all query BigQuery successfully
✓ `python manage.py check` passes (only pre-existing allauth warnings)
✓ No Event.objects or EntityMention.objects queries for time-series data (only Entity.objects for reference data)

**Ready for 14.1-04-PLAN.md:** Data migration and validation (backfill BigQuery from PostgreSQL, validate data consistency, deprecate PostgreSQL Event/EntityMention models)

---
*Phase: 14.1-bigquery-migration*
*Completed: 2026-01-10*
