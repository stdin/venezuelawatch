---
phase: 06-entity-watch
plan: 03
type: execute
---

<objective>
Create REST API endpoints for entity trending leaderboard with metric toggles, entity profile details, and entity timeline of mentions.

Purpose: Provide data access layer for frontend Entity Watch dashboard with flexible filtering and sorting
Output: API endpoints at /api/entities with trending, profile, timeline, OpenAPI docs
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-entity-watch/06-CONTEXT.md
@.planning/phases/06-entity-watch/DISCOVERY.md
@.planning/phases/06-entity-watch/06-01-SUMMARY.md
@.planning/phases/06-entity-watch/06-02-SUMMARY.md
@backend/data_pipeline/api.py
@backend/data_pipeline/schemas.py
@backend/core/models.py

**From Plan 06-01:**
- Entity and EntityMention models with fuzzy matching

**From Plan 06-02:**
- TrendingService with Redis-based leaderboard
- Entity extraction populating Entity/EntityMention tables

**From Phase 5:**
- Events API at /api/risk/events with filtering
- API pattern: django-ninja with Pydantic schemas, registered in venezuelawatch/api.py

**From 06-CONTEXT.md:**
- Entity leaderboard with metric toggles: "Most mentioned," "Highest risk," "Recently sanctioned"
- Basic profile card: entity type, sanctions status, risk score, mention count, recent events
- Separate "Entities" tab in navigation

**API requirements:**
- GET /api/entities/trending?metric=mentions&limit=50 - Leaderboard with metric toggle
- GET /api/entities/{entity_id} - Entity profile details
- GET /api/entities/{entity_id}/timeline?days=30 - Entity mention timeline
- All endpoints authenticated (django-ninja @api.get decorator with auth)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Pydantic schemas for entity API responses</name>
  <files>backend/data_pipeline/schemas.py</files>
  <action>
Add to backend/data_pipeline/schemas.py (after existing RiskIntelligenceEventSchema):

1. **EntitySchema** - Basic entity info for leaderboard
   - id: UUID
   - canonical_name: str
   - entity_type: str (PERSON, ORGANIZATION, GOVERNMENT, LOCATION)
   - mention_count: int
   - first_seen: datetime
   - last_seen: datetime
   - trending_score: Optional[float] = None (from Redis, may be null)
   - trending_rank: Optional[int] = None (1-indexed rank)

2. **EntityProfileSchema** - Detailed entity profile
   - Inherits all fields from EntitySchema
   - aliases: List[str]
   - metadata: Optional[dict] = None
   - sanctions_status: bool (True if any sanctions matches)
   - risk_score: Optional[float] = None (avg risk from events)
   - recent_events: List[dict] (last 5 events mentioning entity)

3. **EntityMentionSchema** - Entity mention details for timeline
   - id: UUID
   - raw_name: str
   - match_score: float
   - relevance: Optional[float] = None
   - mentioned_at: datetime
   - event_summary: dict with {id, title, source, event_type, risk_score, severity, timestamp}

4. **EntityTimelineResponse** - Timeline aggregation
   - entity_id: UUID
   - canonical_name: str
   - total_mentions: int
   - mentions: List[EntityMentionSchema]
   - time_range: dict with {start: datetime, end: datetime}

Use from pydantic import BaseModel, Field for type validation.
Add @staticmethod from_orm methods for converting Django models to schemas where helpful.
  </action>
  <verify>python backend/manage.py check passes, schemas import successfully</verify>
  <done>Pydantic schemas defined for entity API responses, supports leaderboard, profile, timeline</done>
</task>

<task type="auto">
  <name>Task 2: Create entity API router with trending, profile, timeline endpoints</name>
  <files>backend/data_pipeline/api.py, backend/venezuelawatch/api.py</files>
  <action>
In backend/data_pipeline/api.py, add entity_router AFTER existing risk_router:

```python
from ninja import Router
from django.shortcuts import get_object_or_404
from typing import List, Optional
from .schemas import EntitySchema, EntityProfileSchema, EntityTimelineResponse
from core.models import Entity, EntityMention, SanctionsMatch, Event
from .services.trending_service import TrendingService
from datetime import datetime, timedelta

entity_router = Router()

@entity_router.get("/trending", response=List[EntitySchema], tags=["entities"])
def get_trending_entities(
    request,
    metric: str = "mentions",  # mentions, risk, sanctions
    limit: int = 50,
    entity_type: Optional[str] = None  # Filter by PERSON, ORGANIZATION, etc.
):
    """
    Get trending entities leaderboard with metric toggle.

    Metrics:
    - mentions: Most mentioned entities (time-decayed score from Redis)
    - risk: Highest risk entities (avg risk_score from events)
    - sanctions: Recently sanctioned entities
    """
    trending = TrendingService.get_trending_entities(metric=metric, limit=limit)

    # Filter by entity_type if provided
    if entity_type:
        trending = [e for e in trending if e['entity_type'] == entity_type]

    return trending

@entity_router.get("/{entity_id}", response=EntityProfileSchema, tags=["entities"])
def get_entity_profile(request, entity_id: str):
    """Get detailed entity profile with sanctions status and recent events."""
    entity = get_object_or_404(Entity, id=entity_id)

    # Check sanctions status
    sanctions_status = SanctionsMatch.objects.filter(
        event__entity_mentions__entity=entity
    ).exists()

    # Calculate avg risk score from events
    mentions = EntityMention.objects.filter(entity=entity).select_related('event')
    risk_scores = [m.event.risk_score for m in mentions if m.event.risk_score]
    avg_risk = sum(risk_scores) / len(risk_scores) if risk_scores else None

    # Get recent events (last 5)
    recent_mentions = mentions.order_by('-mentioned_at')[:5]
    recent_events = [
        {
            'id': str(m.event.id),
            'title': m.event.title,
            'source': m.event.source,
            'event_type': m.event.event_type,
            'risk_score': m.event.risk_score,
            'severity': m.event.severity,
            'timestamp': m.event.timestamp
        }
        for m in recent_mentions
    ]

    # Get trending rank
    trending_rank = TrendingService.get_entity_rank(str(entity.id))

    return {
        'id': entity.id,
        'canonical_name': entity.canonical_name,
        'entity_type': entity.entity_type,
        'mention_count': entity.mention_count,
        'first_seen': entity.first_seen,
        'last_seen': entity.last_seen,
        'aliases': entity.aliases,
        'metadata': entity.metadata,
        'sanctions_status': sanctions_status,
        'risk_score': avg_risk,
        'recent_events': recent_events,
        'trending_rank': trending_rank
    }

@entity_router.get("/{entity_id}/timeline", response=EntityTimelineResponse, tags=["entities"])
def get_entity_timeline(request, entity_id: str, days: int = 30):
    """Get entity mention timeline for specified time range."""
    entity = get_object_or_404(Entity, id=entity_id)
    cutoff = datetime.utcnow() - timedelta(days=days)

    mentions = EntityMention.objects.filter(
        entity=entity,
        mentioned_at__gte=cutoff
    ).select_related('event').order_by('-mentioned_at')

    mention_schemas = [
        {
            'id': m.id,
            'raw_name': m.raw_name,
            'match_score': m.match_score,
            'relevance': m.relevance,
            'mentioned_at': m.mentioned_at,
            'event_summary': {
                'id': str(m.event.id),
                'title': m.event.title,
                'source': m.event.source,
                'event_type': m.event.event_type,
                'risk_score': m.event.risk_score,
                'severity': m.event.severity,
                'timestamp': m.event.timestamp
            }
        }
        for m in mentions
    ]

    return {
        'entity_id': entity.id,
        'canonical_name': entity.canonical_name,
        'total_mentions': mentions.count(),
        'mentions': mention_schemas,
        'time_range': {
            'start': cutoff,
            'end': datetime.utcnow()
        }
    }
```

Then register entity_router in backend/venezuelawatch/api.py:
```python
from data_pipeline.api import risk_router, entity_router

api.add_router("/risk/", risk_router)
api.add_router("/entities/", entity_router)
```

Use prefetch_related and select_related to avoid N+1 queries.
  </action>
  <verify>python backend/manage.py runserver starts, visit http://localhost:8000/api/docs shows entity endpoints</verify>
  <done>Entity API endpoints functional: /api/entities/trending, /api/entities/{id}, /api/entities/{id}/timeline, documented in OpenAPI</done>
</task>

<task type="auto">
  <name>Task 3: Test entity API endpoints with curl and document responses</name>
  <files>backend/docs/entity-api.md</files>
  <action>
Test entity API endpoints:

```bash
# Get trending entities (mentions metric)
curl http://localhost:8000/api/entities/trending?metric=mentions&limit=10

# Get trending with risk metric
curl http://localhost:8000/api/entities/trending?metric=risk&limit=10

# Get entity profile
ENTITY_ID=$(curl -s http://localhost:8000/api/entities/trending?limit=1 | python -c "import sys, json; print(json.load(sys.stdin)[0]['id'])")
curl http://localhost:8000/api/entities/$ENTITY_ID

# Get entity timeline
curl http://localhost:8000/api/entities/$ENTITY_ID/timeline?days=30
```

Create backend/docs/entity-api.md with:
- API reference for all endpoints with parameters
- Response schemas with example JSON
- Metric toggle documentation (mentions, risk, sanctions)
- Integration guide for Phase 6 frontend
- Performance notes (Redis caching, prefetch_related usage)

Add link to backend/README.md.
  </action>
  <verify>All API endpoints return valid JSON, OpenAPI docs complete, entity-api.md created</verify>
  <done>Entity API tested and documented, ready for frontend integration</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] EntitySchema, EntityProfileSchema, EntityTimelineResponse Pydantic schemas defined
- [ ] Entity API router with 3 endpoints: trending, profile, timeline
- [ ] entity_router registered at /api/entities/ in venezuelawatch/api.py
- [ ] OpenAPI docs at /api/docs show entity endpoints
- [ ] Manual curl tests pass, return valid JSON
- [ ] backend/docs/entity-api.md documentation created
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Entity API endpoints functional and documented
- Metric toggle working (mentions, risk, sanctions)
- Ready for frontend Entity Watch dashboard integration
  </success_criteria>

<output>
After completion, create `.planning/phases/06-entity-watch/06-03-SUMMARY.md`:

# Phase 6 Plan 3: Entity API & Trending Endpoints Summary

**[Substantive one-liner - what shipped, not "phase complete"]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `path/to/file.ts` - Description
- `path/to/another.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 06-04-PLAN.md (Frontend Entity Leaderboard & Profiles)
</output>
