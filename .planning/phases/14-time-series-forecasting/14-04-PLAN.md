---
phase: 14-time-series-forecasting
plan: 04
type: execute
---

<objective>
Build frontend forecast visualization that shows entity risk trajectories with historical data and predicted trends.

Purpose: Add contextual forecast widgets to entity profiles showing 30-day risk trajectory with confidence bands, dimensional breakdowns, and timestamps.
Output: Interactive forecast charts integrated into entity profile pages, displaying historical + predicted risk scores with visual confidence intervals.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-time-series-forecasting/14-CONTEXT.md
@.planning/phases/14-time-series-forecasting/14-RESEARCH.md
@.planning/phases/14-time-series-forecasting/14-01-SUMMARY.md
@.planning/phases/14-time-series-forecasting/14-02-SUMMARY.md
@.planning/phases/14-time-series-forecasting/14-03-SUMMARY.md

**Tech stack available:**
- React 18 with TypeScript (from Phase 1)
- Recharts for visualization (from Phase 10)
- React Query for data fetching (from Phase 10)
- Mantine UI components (from Phase 9)
- Entity profile page layout (from Phase 11)

**Established patterns:**
- Mantine Card wrapper for charts (from Phase 10)
- Skeleton loading for perceived performance (from Phase 10)
- Badge colors for risk scores (from Phase 10)
- date-fns for date manipulation (from Phase 10)

**From CONTEXT.md:**
- Contextual forecast widgets (not dedicated page)
- Visual trajectory: historical + forecasted line with shaded confidence band
- "Forecast generated X hours ago" timestamp for freshness
- Disabled with explanation when insufficient data
- Dimensional breakdown visible upfront (no progressive disclosure)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create forecast chart component with Recharts</name>
  <files>frontend/src/components/forecasting/EntityForecastChart.tsx, frontend/src/api/forecasting.ts</files>
  <action>
    1. Create API client in `frontend/src/api/forecasting.ts`:

    ```typescript
    import { apiClient } from './client';

    export interface ForecastPoint {
      ds: string;  // ISO timestamp
      yhat: number;  // Predicted value
      yhat_lower: number;  // Lower confidence bound
      yhat_upper: number;  // Upper confidence bound
    }

    export interface ForecastResponse {
      status: 'ready' | 'insufficient_data' | 'error';
      forecast?: ForecastPoint[];
      generated_at?: string;
      horizon_days: number;
      message?: string;
    }

    export async function fetchEntityForecast(
      entityId: number,
      horizonDays: number = 30
    ): Promise<ForecastResponse> {
      const response = await apiClient.post(
        `/forecasting/entities/${entityId}/forecast`,
        { horizon_days: horizonDays }
      );
      return response.data;
    }
    ```

    2. Create chart component in `frontend/src/components/forecasting/EntityForecastChart.tsx`:

    ```typescript
    import { Card, Text, Skeleton, Alert, Badge } from '@mantine/core';
    import { LineChart, Line, Area, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } from 'recharts';
    import { useQuery } from '@tanstack/react-query';
    import { fetchEntityForecast } from '@/api/forecasting';
    import { format, parseISO, formatDistanceToNow } from 'date-fns';

    interface EntityForecastChartProps {
      entityId: number;
      historicalData?: Array<{ date: string; risk_score: number }>;
    }

    export function EntityForecastChart({ entityId, historicalData }: EntityForecastChartProps) {
      const { data, isLoading, error } = useQuery({
        queryKey: ['entity-forecast', entityId],
        queryFn: () => fetchEntityForecast(entityId, 30),
        staleTime: 1000 * 60 * 60,  // 1 hour (forecasts cached 24h on backend)
      });

      if (isLoading) {
        return (
          <Card shadow="sm" padding="lg" radius="md" withBorder>
            <Skeleton height={300} />
          </Card>
        );
      }

      if (data?.status === 'insufficient_data') {
        return (
          <Card shadow="sm" padding="lg" radius="md" withBorder>
            <Alert color="gray" title="Insufficient Data">
              {data.message || 'Need at least 14 days of history to generate forecast'}
            </Alert>
          </Card>
        );
      }

      if (data?.status === 'error' || error) {
        return (
          <Card shadow="sm" padding="lg" radius="md" withBorder>
            <Alert color="red" title="Forecast Error">
              {data?.message || 'Unable to generate forecast'}
            </Alert>
          </Card>
        );
      }

      // Combine historical + forecast data
      const chartData = [
        ...(historicalData?.map(d => ({
          date: d.date,
          actual: d.risk_score,
          type: 'historical'
        })) || []),
        ...(data?.forecast?.map(f => ({
          date: format(parseISO(f.ds), 'yyyy-MM-dd'),
          forecast: f.yhat,
          forecast_lower: f.yhat_lower,
          forecast_upper: f.yhat_upper,
          type: 'predicted'
        })) || [])
      ];

      const generatedAgo = data?.generated_at
        ? formatDistanceToNow(parseISO(data.generated_at), { addSuffix: true })
        : null;

      return (
        <Card shadow="sm" padding="lg" radius="md" withBorder>
          <Card.Section p="sm" withBorder>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
              <Text size="lg" fw={600}>Risk Score Forecast</Text>
              {generatedAgo && (
                <Badge size="sm" variant="light" color="gray">
                  Forecast generated {generatedAgo}
                </Badge>
              )}
            </div>
          </Card.Section>

          <ResponsiveContainer width="100%" height={300}>
            <LineChart data={chartData} margin={{ top: 10, right: 30, left: 0, bottom: 0 }}>
              <CartesianGrid strokeDasharray="3 3" stroke="var(--mantine-color-gray-3)" />
              <XAxis
                dataKey="date"
                tickFormatter={(date) => format(parseISO(date), 'MMM dd')}
                stroke="var(--mantine-color-gray-6)"
              />
              <YAxis
                domain={[0, 100]}
                stroke="var(--mantine-color-gray-6)"
              />
              <Tooltip
                contentStyle={{
                  backgroundColor: 'var(--mantine-color-body)',
                  border: '1px solid var(--mantine-color-gray-3)'
                }}
                labelFormatter={(date) => format(parseISO(date), 'MMM dd, yyyy')}
              />
              <Legend />

              {/* Historical data line */}
              <Line
                type="monotone"
                dataKey="actual"
                stroke="var(--mantine-color-blue-filled)"
                strokeWidth={2}
                dot={false}
                name="Historical Risk"
              />

              {/* Forecast line */}
              <Line
                type="monotone"
                dataKey="forecast"
                stroke="var(--color-risk-high)"
                strokeWidth={2}
                strokeDasharray="5 5"
                dot={false}
                name="Forecasted Risk"
              />

              {/* Confidence band (shaded area) */}
              <Area
                type="monotone"
                dataKey="forecast_upper"
                stroke="none"
                fill="var(--color-risk-high)"
                fillOpacity={0.2}
                name="Confidence Upper"
              />
              <Area
                type="monotone"
                dataKey="forecast_lower"
                stroke="none"
                fill="var(--color-risk-high)"
                fillOpacity={0.2}
                name="Confidence Lower"
              />
            </LineChart>
          </ResponsiveContainer>

          <Text size="xs" c="dimmed" mt="sm">
            Directional indicator based on historical patterns. Confidence band shows prediction uncertainty.
          </Text>
        </Card>
      );
    }
    ```

    Chart combines historical data (solid line) with forecast (dashed line extending into future). Shaded area between yhat_lower and yhat_upper shows confidence band (like weather forecasts per CONTEXT.md). Timestamp badge shows "Forecast generated X ago" for freshness. Disabled state with explanation when insufficient data. Uses Mantine Card wrapper and design tokens for consistency.
  </action>
  <verify>
    1. Check: npm run dev starts without errors
    2. Verify: Component imports compile without TypeScript errors
    3. Test: Visit entity profile, forecast chart renders or shows appropriate message
  </verify>
  <done>EntityForecastChart component created with historical + forecasted visualization. Confidence band rendered as shaded area. Timestamp badge shows forecast age. Insufficient data shows Alert with explanation. API client created for forecast endpoint.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate forecast widget into entity profiles</name>
  <files>frontend/src/pages/entities/EntityProfile.tsx, frontend/src/api/entities.ts</files>
  <action>
    Update entity profile page to include forecast chart in Risk Intelligence section:

    1. Modify `frontend/src/pages/entities/EntityProfile.tsx` to add forecast chart:

    ```typescript
    import { EntityForecastChart } from '@/components/forecasting/EntityForecastChart';

    // Inside EntityProfile component, after risk intelligence cards:

    {/* Risk Score Forecast */}
    <Grid.Col span={{ base: 12 }}>
      <EntityForecastChart
        entityId={entity.id}
        historicalData={entity.risk_history}  // Last 30 days from profile API
      />
    </Grid.Col>
    ```

    2. Update entity profile API to include risk_history:

    Modify `frontend/src/api/entities.ts` to fetch historical risk scores:

    ```typescript
    export interface EntityProfile {
      // ... existing fields
      risk_history?: Array<{
        date: string;
        risk_score: number;
      }>;
    }

    // Update fetchEntityProfile to request history parameter:
    export async function fetchEntityProfile(entityId: number): Promise<EntityProfile> {
      const response = await apiClient.get(`/entities/${entityId}/profile?include_history=true`);
      return response.data;
    }
    ```

    3. Backend API update (if needed):

    Check if `backend/entities/api.py` profile endpoint supports `include_history` parameter. If not, add query to fetch last 30 days:

    ```python
    @router.get('/{entity_id}/profile', response=EntityProfileSchema)
    def get_entity_profile(request, entity_id: int, include_history: bool = False):
        # ... existing code ...

        if include_history:
            # Get last 30 days of risk score history
            from django.db.models import Avg
            from datetime import timedelta

            history = EntityMention.objects.filter(
                entity_id=entity_id,
                mentioned_at__gte=timezone.now() - timedelta(days=30)
            ).values('mentioned_at__date').annotate(
                risk_score=Avg('entity__risk_score')
            ).order_by('mentioned_at__date')

            profile['risk_history'] = [
                {'date': str(h['mentioned_at__date']), 'risk_score': h['risk_score']}
                for h in history
            ]

        return profile
    ```

    Forecast chart appears in entity profile below existing risk intelligence cards. Historical data (last 30 days) fetched from profile endpoint provides context. Chart shows seamless transition from historical (solid) to predicted (dashed) line with confidence band. Per CONTEXT.md, forecast is contextual (on profile page) not dedicated page.
  </action>
  <verify>
    1. Check: npm run dev compiles without errors
    2. Verify: Entity profile page includes forecast chart
    3. Test: Historical data connects smoothly to forecast line
    4. Confirm: Confidence band visible as shaded area
    5. Check: "Forecast generated X ago" timestamp displays
  </verify>
  <done>Forecast chart integrated into entity profile Risk Intelligence section. Historical risk scores (30 days) fetched from profile endpoint. Chart positioned contextually (not separate page per CONTEXT.md). Smooth visual transition from historical to forecasted trajectory.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Entity risk forecast visualization with historical data, predictions, and confidence intervals</what-built>
  <how-to-verify>
    1. Run: npm run dev (frontend) and python backend/manage.py runserver (backend)
    2. Visit: http://localhost:5173/entities/[ENTITY_ID] (choose entity with 14+ days history)
    3. Scroll to: Risk Intelligence section, find "Risk Score Forecast" card
    4. Check visual elements:
       - Historical data: Solid blue line (past 30 days)
       - Forecast line: Dashed red line extending 30 days into future
       - Confidence band: Shaded area between upper/lower bounds
       - Timestamp badge: "Forecast generated X ago" in top-right
       - Legend: Shows "Historical Risk" and "Forecasted Risk" labels
    5. Test insufficient data:
       - Visit entity with <14 days history
       - Should show gray Alert: "Insufficient Data - Need at least 14 days of history..."
    6. Check responsiveness:
       - Desktop (>1024px): Chart fills card width
       - Tablet/mobile: Chart adapts to narrower width
    7. Verify disclaimer: "Directional indicator based on historical patterns" text visible below chart
  </how-to-verify>
  <resume-signal>Type "approved" to continue or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] EntityForecastChart component renders without errors
- [ ] Historical + forecast data combined smoothly
- [ ] Confidence band visible as shaded area
- [ ] Timestamp badge shows forecast age
- [ ] Insufficient data case displays appropriate message
- [ ] Chart integrated into entity profile page
- [ ] Visual verification checkpoint passed
- [ ] Responsive across desktop/tablet/mobile
</verification>

<success_criteria>
- All tasks completed
- Forecast visualization operational on entity profiles
- Historical data connects seamlessly to predictions
- Confidence intervals displayed as intuitive shaded bands
- Timestamp and disclaimer provide context per CONTEXT.md requirements
- Phase 14 complete - entity risk trajectory forecasting shipped
</success_criteria>

<output>
After completion, create `.planning/phases/14-time-series-forecasting/14-04-SUMMARY.md`:

# Phase 14 Plan 4: Frontend Forecast Visualization Summary

**Entity risk forecasting live: contextual trajectory charts with 30-day predictions and confidence intervals on entity profiles**

## Accomplishments

- Created EntityForecastChart component with Recharts visualization
- Integrated historical (30 days) + forecasted (30 days) risk trajectory
- Rendered confidence bands as shaded area (upper/lower bounds)
- Added timestamp badge "Forecast generated X ago" for freshness
- Handled insufficient data case with clear explanation
- Integrated forecast widget into entity profile Risk Intelligence section
- Verified visual quality and responsiveness (desktop/tablet/mobile)

## Files Created/Modified

- `frontend/src/components/forecasting/EntityForecastChart.tsx` - Forecast chart component
- `frontend/src/api/forecasting.ts` - Forecast API client
- `frontend/src/pages/entities/EntityProfile.tsx` - Added forecast chart to profile
- `frontend/src/api/entities.ts` - Updated profile API for historical data
- `backend/entities/api.py` - Added include_history parameter to profile endpoint

## Decisions Made

- Contextual placement on entity profile (not dedicated page) per CONTEXT.md
- Historical data as solid line, forecast as dashed line (visual distinction)
- Confidence band as shaded area (intuitive, like weather forecasts)
- 30-day historical + 30-day forecast provides good context window
- Timestamp badge (not just text) for visual prominence
- Gray Alert for insufficient data (not hidden button) per CONTEXT.md
- Always-visible disclaimer below chart for expectation setting

## Issues Encountered

[Document any chart rendering issues, data formatting challenges, or "None"]

## Next Step

Phase 14 complete! Entity risk forecasting shipped with:
- BigQuery ETL pipeline (daily sync)
- Vertex AI TiDE model (trained and deployed)
- Django REST API (24-hour caching)
- Frontend visualization (contextual widget)

Ready for Phase 15: Correlation & Pattern Analysis
</output>
