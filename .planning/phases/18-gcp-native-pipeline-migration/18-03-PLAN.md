---
phase: 18-gcp-native-pipeline-migration
plan: 03
type: execute
---

<objective>
Complete big-bang cutover from Celery to GCP-native services and remove all Celery/Redis infrastructure.

Purpose: Finalize migration to serverless architecture, eliminate operational overhead of managing Celery workers and Redis instances, achieve target state of fully GCP-native orchestration.
Output: Celery and Redis completely removed from codebase, GCP services handling 100% of orchestration, operational monitoring dashboard validating zero data loss, documentation updated.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/GCP-NATIVE-ORCHESTRATION-RESEARCH.md
@.planning/phases/18-gcp-native-pipeline-migration/18-CONTEXT.md

**Completed migrations:**
- Plan 18-01: Ingestion layer → Cloud Scheduler + Cloud Functions
- Plan 18-02: Processing layer → Pub/Sub + Cloud Tasks

**Files to clean up:**
@backend/venezuelawatch/settings.py (CELERY_* settings)
@backend/venezuelawatch/celery.py
@backend/data_pipeline/tasks/__init__.py
@backend/data_pipeline/tasks/base.py
@backend/requirements.txt (celery, redis dependencies)

**Key constraint from context:** Big-bang cutover means disable Celery Beat completely, monitor GCP services for 48 hours, then remove all Celery code. No gradual migration, clean break.

**Rollback plan (if needed):**
- Re-enable CELERY_BEAT_SCHEDULE entries in settings.py
- Restart Celery workers
- Disable Cloud Scheduler jobs (pause, not delete)
- Requires ~15 minutes to restore Celery-based ingestion
</context>

<tasks>

<task type="auto">
  <name>Task 1: Disable Celery Beat and deploy GCP-native services to production</name>
  <files>backend/venezuelawatch/settings.py, scripts/cutover_to_gcp.sh</files>
  <action>
Create cutover script `scripts/cutover_to_gcp.sh` that orchestrates big-bang migration:

**Step 1: Disable Celery Beat schedule**

In `backend/venezuelawatch/settings.py`, empty the CELERY_BEAT_SCHEDULE with migration comment.

**Step 2: Deploy Django to Cloud Run with Pub/Sub handlers**

**Step 3: Enable Cloud Scheduler jobs (resume if paused)**

**Step 4: Stop Celery workers**

Big-bang cutover: Celery Beat disabled → Cloud Scheduler takes over immediately → Zero downtime for Chat API.
  </action>
  <verify>
Verify Celery Beat disabled, Cloud Scheduler jobs active, Cloud Run deployed, Pub/Sub subscriptions configured correctly
  </verify>
  <done>Celery disabled, GCP services operational</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>GCP-native orchestration fully operational, Celery completely disabled</what-built>
  <how-to-verify>
Monitor GCP services for 48 hours: Cloud Scheduler execution, Cloud Functions metrics, BigQuery data validation, Pub/Sub & Cloud Tasks flow, cost monitoring, error rates, end-to-end flow testing.

Success criteria: All ingestion functions execute on schedule, zero data loss, no duplicates, LLM analysis working, costs within $1.60-3.60/month, error rate < 1%.
  </how-to-verify>
  <resume-signal>Type "approved" if validation passed for 48 hours, or describe issues to fix</resume-signal>
</task>

<task type="auto">
  <name>Task 2: Remove Celery and Redis dependencies from codebase</name>
  <files>backend/requirements.txt, backend/venezuelawatch/settings.py, backend/venezuelawatch/celery.py, backend/data_pipeline/tasks/*.py, docs/ARCHITECTURE.md</files>
  <action>
Clean removal of all Celery infrastructure after 48-hour validation:

**1. Remove Celery dependencies from requirements.txt:**
- celery[redis]
- redis
- django-celery-results
- django-celery-beat

**2. Delete Celery configuration:**
- backend/venezuelawatch/celery.py (entire file)
- Remove all CELERY_* settings from settings.py (broker_url, result_backend, etc.)

**3. Delete deprecated task files:**
- backend/data_pipeline/tasks/gdelt_tasks.py (DOC API polling - replaced by gdelt_sync_task.py)
- backend/data_pipeline/tasks/base.py (BaseIngestionTask class - not needed)
- Mark remaining task files as deprecated with comments (intelligence_tasks.py, entity_extraction.py)

**4. Update documentation:**
Create/update docs/ARCHITECTURE.md with GCP-native architecture diagram showing:
- Ingestion: Cloud Scheduler → Cloud Functions → BigQuery → Pub/Sub
- Processing: Pub/Sub → Cloud Run → Cloud Tasks → LLM/Entity services
- Storage: BigQuery (time-series), PostgreSQL (relational), Redis (trending cache only)

**5. Remove Redis infrastructure (optionally downscale):**
- If using Redis only for trending cache: Keep but downscale to minimal instance
- If not using Redis at all: Delete Memorystore instance entirely

Why: Clean break philosophy from context. All orchestration now GCP-native. Redis optionally kept for trending cache only (much smaller footprint than Celery queue).
  </action>
  <verify>
```bash
# Verify Celery dependencies removed
grep -i celery backend/requirements.txt
# Should return nothing

# Verify no Celery imports in active code
grep -r "from celery import\|import celery" backend/ --include="*.py" | grep -v "# DEPRECATED"

# Verify Django starts without Celery
cd backend && python manage.py check

# Verify tests pass
python manage.py test
```
  </verify>
  <done>Celery dependencies removed from requirements.txt, celery.py deleted, deprecated task files marked or removed, documentation updated with GCP architecture, Django runs without Celery, tests pass</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Celery Beat disabled in settings.py
- [ ] Cloud Scheduler jobs active and executing
- [ ] 48-hour validation passed (zero data loss)
- [ ] Celery dependencies removed from requirements.txt
- [ ] celery.py configuration file deleted
- [ ] Documentation updated with GCP-native architecture
- [ ] Django application runs without Celery
- [ ] All tests pass
</verification>

<success_criteria>

- All tasks completed
- GCP-native orchestration handling 100% of data pipeline
- Zero data loss validated over 48 hours
- Celery and Redis completely removed from codebase
- Documentation reflects new architecture
- Cost reduced from $20-40/month to $1.60-3.60/month
- Phase 18 migration complete: operational simplicity achieved
</success_criteria>

<output>
After completion, create `.planning/phases/18-gcp-native-pipeline-migration/18-03-SUMMARY.md`:

# Phase 18 Plan 03: Cutover & Infrastructure Cleanup Summary

**Celery completely removed, GCP-native orchestration operational, target architecture achieved**

## Accomplishments

- Disabled Celery Beat schedule (CELERY_BEAT_SCHEDULE = {})
- Deployed Django to Cloud Run with Pub/Sub/Cloud Tasks handlers
- Enabled Cloud Scheduler jobs (all 6 ingestion tasks)
- Validated GCP services for 48 hours with zero data loss
- Removed all Celery and Redis dependencies from codebase
- Deleted deprecated task files and Celery configuration
- Updated architecture documentation

## Files Created/Modified

- `backend/venezuelawatch/settings.py` - Removed all CELERY_* settings
- `backend/requirements.txt` - Removed celery, redis dependencies
- `scripts/cutover_to_gcp.sh` - Big-bang cutover automation
- `docs/ARCHITECTURE.md` - Updated with GCP-native architecture diagram
- **Deleted:** `backend/venezuelawatch/celery.py`
- **Deleted:** `backend/data_pipeline/tasks/base.py`
- **Deleted:** `backend/data_pipeline/tasks/gdelt_tasks.py` (DOC API version)

## Decisions Made

- Big-bang cutover (not gradual) for clean break and operational simplicity
- 48-hour validation period before Celery removal
- Keep Redis optionally for trending cache (downscaled from queue usage)
- All task orchestration now GCP-native (Cloud Scheduler + Pub/Sub + Cloud Tasks)

## Issues Encountered

None (or document any issues with resolutions)

## Operational Wins

- **Cost reduction:** $20-40/month → $1.60-3.60/month (85-91% reduction)
- **Auto-scaling:** Cloud Run 0→100 instances (no manual worker management)
- **Unified observability:** All logs in Cloud Logging, Error Reporting, Trace
- **Simpler deployments:** Independent function deployments, no worker coordination
- **Built-in retries:** Cloud Tasks handles exponential backoff automatically

## Next Step

Phase 18 complete! GCP-native pipeline migration achieved. 

Ready for Phase 15-02 (Correlation & Pattern Analysis continuation) or Phase 17 (Custom Reports & Export).
</output>
