---
phase: 02-authentication-user-management
plan: 01
type: execute
---

<objective>
Set up django-allauth with headless mode and create custom User model supporting future team features.

Purpose: Establish authentication foundation with JWT support for React SPA while designing User model that won't require migration when team features are added.
Output: Working django-allauth installation with custom User model, JWT configured, migrations applied.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-authentication-user-management/DISCOVERY.md

**Tech stack available:**
- Django 5.2 with django-ninja API framework
- PostgreSQL database with TimescaleDB
- CORS middleware configured for localhost:5173
- React 18 frontend with Vite proxy

**Key files from Phase 1:**
@backend/venezuelawatch/settings.py
@backend/requirements.txt
@backend/core/models.py

**Constraining decisions:**
- Phase 1: django-ninja for REST API (continue using for protected endpoints)
- Phase 1: CORS for Vite dev server (extend for auth credentials)
- Discovery: django-allauth headless for SPA authentication (not dj-rest-auth)
- Discovery: JWT in httpOnly cookies (not localStorage or session auth)
- Discovery: Custom User model NOW to avoid migration pain for future teams
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install django-allauth and configure settings</name>
  <files>backend/requirements.txt, backend/venezuelawatch/settings.py</files>
  <action>
Add django-allauth to requirements.txt:
- django-allauth>=0.63.0 (headless support)
- djangorestframework-simplejwt>=5.3 (JWT backend for allauth)

In settings.py:
1. Add to INSTALLED_APPS (order matters):
   - 'allauth'
   - 'allauth.account'
   - 'allauth.headless'
   - Add after 'django.contrib.sites' (also add sites if missing)

2. Set SITE_ID = 1 (required by allauth)

3. Add allauth configuration:
   - ACCOUNT_EMAIL_VERIFICATION = 'optional' (can be disabled for Phase 2)
   - ACCOUNT_EMAIL_VERIFICATION_BY_CODE_ENABLED = True (better for headless)
   - HEADLESS_FRONTEND_URLS = {
       "ACCOUNT_ACTIVATION_URL": "http://localhost:5173/auth/verify/",
       "PASSWORD_RESET_URL": "http://localhost:5173/auth/reset/",
     }

4. Add to MIDDLEWARE (before CommonMiddleware):
   - 'allauth.account.middleware.AccountMiddleware'

5. Update CORS settings:
   - CORS_ALLOW_CREDENTIALS = True (required for httpOnly cookies)

Do NOT run pip install yet - verification will handle that. Do NOT add django.contrib.sites to INSTALLED_APPS if it doesn't exist (will add in migrations task).
  </action>
  <verify>
grep "django-allauth" backend/requirements.txt shows version
grep "allauth.headless" backend/venezuelawatch/settings.py exists
grep "CORS_ALLOW_CREDENTIALS = True" backend/venezuelawatch/settings.py exists
  </verify>
  <done>requirements.txt has django-allauth and djangorestframework-simplejwt, settings.py has allauth in INSTALLED_APPS with headless configuration and CORS_ALLOW_CREDENTIALS=True</done>
</task>

<task type="auto">
  <name>Task 2: Create custom User model with team-ready fields</name>
  <files>backend/core/models.py, backend/venezuelawatch/settings.py</files>
  <action>
In backend/core/models.py:

1. Import: from django.contrib.auth.models import AbstractUser

2. Create User model extending AbstractUser:
```python
class User(AbstractUser):
    """
    Custom user model with team-ready fields.

    Phase 2: Individual users (role='individual')
    Future: Add Team model with ForeignKey when team features needed
    """
    # Team-ready fields (nullable for backward compat when teams added)
    organization_name = models.CharField(max_length=200, blank=True, default='')
    role = models.CharField(
        max_length=50,
        default='individual',
        choices=[
            ('individual', 'Individual User'),
            ('team_member', 'Team Member'),
            ('team_admin', 'Team Admin'),
            ('org_admin', 'Organization Admin'),
        ]
    )

    # SaaS fields
    subscription_tier = models.CharField(
        max_length=50,
        default='free',
        choices=[
            ('free', 'Free'),
            ('pro', 'Professional'),
            ('enterprise', 'Enterprise'),
        ]
    )

    # User preferences
    timezone = models.CharField(max_length=50, default='UTC')

    # Metadata
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        db_table = 'users'
        ordering = ['-date_joined']

    def __str__(self):
        return self.email or self.username
```

3. Keep existing Event model below User model (do not modify it).

In backend/venezuelawatch/settings.py:
- Add AUTH_USER_MODEL = 'core.User' (place after INSTALLED_APPS, before MIDDLEWARE)

CRITICAL: This must be done BEFORE any migrations are created. If migrations already exist, this will cause issues.
  </action>
  <verify>
grep "class User(AbstractUser)" backend/core/models.py exists
grep "AUTH_USER_MODEL = 'core.User'" backend/venezuelawatch/settings.py exists
python backend/manage.py check shows no issues
  </verify>
  <done>User model created with organization_name, role, subscription_tier, timezone fields. AUTH_USER_MODEL configured. Django check passes.</done>
</task>

<task type="auto">
  <name>Task 3: Install dependencies, add sites framework, and run migrations</name>
  <files>backend/venezuelawatch/settings.py, backend/core/migrations/</files>
  <action>
1. Install new dependencies:
   cd backend && pip install django-allauth>=0.63.0 djangorestframework-simplejwt>=5.3

2. Add django.contrib.sites to INSTALLED_APPS in settings.py (required by allauth):
   - Add 'django.contrib.sites' before 'allauth' in INSTALLED_APPS

3. Run Django check:
   python backend/manage.py check

4. Create and apply migrations for User model:
   cd backend
   python manage.py makemigrations
   python manage.py migrate

This will:
- Create sites framework tables
- Create custom User model table
- Run allauth migrations
- Update Event model to use new User (if it has foreign keys)

IMPORTANT: If migrations fail due to existing User references, this is expected (since Event model doesn't reference User yet). Migration should succeed with just User table creation.
  </action>
  <verify>
pip list | grep django-allauth shows installed version
python backend/manage.py showmigrations | grep core shows applied migrations
python backend/manage.py showmigrations | grep allauth shows applied migrations
python backend/manage.py showmigrations | grep sites shows applied migrations
  </verify>
  <done>django-allauth and simplejwt installed. Sites framework added. Migrations created and applied successfully. User table exists in database.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] pip list shows django-allauth>=0.63 and djangorestframework-simplejwt>=5.3
- [ ] python backend/manage.py check passes with no errors
- [ ] python backend/manage.py showmigrations shows core, allauth, and sites migrations applied
- [ ] backend/venezuelawatch/settings.py has AUTH_USER_MODEL = 'core.User'
- [ ] backend/venezuelawatch/settings.py has CORS_ALLOW_CREDENTIALS = True
- [ ] backend/core/models.py has User model with team-ready fields
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No migration errors
- Custom User model ready for authentication
- django-allauth configured for headless mode
</success_criteria>

<output>
After completion, create `.planning/phases/02-authentication-user-management/02-01-SUMMARY.md`:

---
phase: 02-authentication-user-management
plan: 01
subsystem: api
tags: [django-allauth, authentication, user-model, jwt]

requires:
  - phase: 01-01
    provides: Django 5.2 backend with settings
  - phase: 01-03
    provides: PostgreSQL database

provides:
  - django-allauth with headless mode configured
  - Custom User model with team-ready fields (organization_name, role, subscription_tier, timezone)
  - JWT authentication backend configured
  - Sites framework integrated

affects: [02-02-auth-endpoints, 02-03-protected-routes, 02-04-react-ui, future-teams]

tech-stack:
  added: [django-allauth 0.63+, djangorestframework-simplejwt 5.3+, django.contrib.sites]
  patterns: [Custom User model with future-proof fields, allauth headless for SPA]

key-files:
  created:
    - backend/core/migrations/000X_user_model.py
  modified:
    - backend/requirements.txt
    - backend/venezuelawatch/settings.py
    - backend/core/models.py

key-decisions:
  - "django-allauth headless for SPA authentication (not dj-rest-auth)"
  - "Custom User model NOW to avoid migration pain for future teams"
  - "JWT in httpOnly cookies via djangorestframework-simplejwt"
  - "CORS_ALLOW_CREDENTIALS=True for cross-origin cookie authentication"

---

# Plan 02-01 Summary: django-allauth Setup & User Model

**[Substantive one-liner]**

## Accomplishments

- Installed and configured django-allauth with headless mode
- Created custom User model with team-ready fields
- Configured JWT authentication backend
- Applied migrations for User model and allauth

## Files Created/Modified

### Created:
- `backend/core/migrations/000X_user_model.py` - User model migration

### Modified:
- `backend/requirements.txt` - Added django-allauth and simplejwt
- `backend/venezuelawatch/settings.py` - AUTH_USER_MODEL, allauth config, CORS credentials
- `backend/core/models.py` - Custom User model with team fields

## Decisions Made

1. **Custom User Model Design**: Added organization_name, role, subscription_tier, timezone fields now to avoid costly migrations when team features are added
2. **django-allauth Headless**: Selected over dj-rest-auth for cleaner django-ninja integration
3. **CORS Credentials**: Enabled CORS_ALLOW_CREDENTIALS for httpOnly cookie authentication

## Issues Encountered

[None or describe any issues]

## Next Phase Readiness

Ready for Plan 02-02 (Authentication Endpoints).
- User model created and migrated
- django-allauth installed and configured
- JWT backend ready for endpoint integration

---

</output>
