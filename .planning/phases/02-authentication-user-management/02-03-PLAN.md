---
phase: 02-authentication-user-management
plan: 03
type: execute
---

<objective>
Protect existing API endpoints with JWT authentication and create user profile endpoint.

Purpose: Apply django-allauth JWT authentication to django-ninja API, demonstrating protected route pattern for future endpoints.
Output: Health endpoint protected, new user profile endpoint created, authentication working end-to-end with OpenAPI docs updated.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-authentication-user-management/DISCOVERY.md
@.planning/phases/02-authentication-user-management/02-01-SUMMARY.md
@.planning/phases/02-authentication-user-management/02-02-SUMMARY.md

**Tech stack available:**
- django-allauth with JWT authentication working
- django-ninja API framework at /api/
- Custom User model with team fields
- JWT tokens in httpOnly cookies

**Key files:**
@backend/venezuelawatch/api.py
@backend/core/api.py
@backend/core/models.py

**Constraining decisions:**
- Phase 1: django-ninja with router pattern (health router in core/api.py)
- Plan 02-02: JWT authentication at /_allauth/, working with curl
- Discovery: Use allauth.headless.contrib.ninja.security.jwt_token_auth for protection
- Discovery: Apply auth at router level for clean separation
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create user profile endpoint with JWT authentication</name>
  <files>backend/core/api.py</files>
  <action>
In backend/core/api.py:

1. Add import at top of file:
   from allauth.headless.contrib.ninja.security import jwt_token_auth

2. Create a new router for user endpoints (separate from health router):

```python
# User endpoints (authenticated)
user_router = Router()

@user_router.get("/me", auth=jwt_token_auth)
def get_current_user(request):
    """Get current authenticated user profile."""
    user = request.auth  # jwt_token_auth sets request.auth to User instance
    return {
        "id": user.id,
        "email": user.email,
        "username": user.username,
        "first_name": user.first_name,
        "last_name": user.last_name,
        "organization_name": user.organization_name,
        "role": user.role,
        "subscription_tier": user.subscription_tier,
        "timezone": user.timezone,
        "date_joined": user.date_joined.isoformat(),
    }
```

3. Keep existing health_router (will protect it in next task):
   - Keep the existing health check endpoint as-is for now

Why jwt_token_auth from allauth.headless.contrib.ninja:
- Integrates django-allauth JWT validation with django-ninja
- Automatically validates JWT from Authorization header or cookies
- Sets request.auth to User instance on success
- Returns 401 if token invalid/missing
- Works with OpenAPI docs (shows lock icon)

Do NOT create custom JWT validation - allauth provides battle-tested implementation.
  </action>
  <verify>
grep "from allauth.headless.contrib.ninja.security import jwt_token_auth" backend/core/api.py exists
grep "user_router = Router()" backend/core/api.py exists
grep 'def get_current_user' backend/core/api.py exists
  </verify>
  <done>User router created with /me endpoint protected by jwt_token_auth. Returns user profile data including team fields.</done>
</task>

<task type="auto">
  <name>Task 2: Mount user router and protect health endpoint</name>
  <files>backend/venezuelawatch/api.py, backend/core/api.py</files>
  <action>
In backend/venezuelawatch/api.py:

1. Import user_router:
   from core.api import router as health_router, user_router

2. Mount user_router:
   api.add_router("/user", user_router, tags=["User Profile"])

3. Keep existing health router mounting:
   api.add_router("/health", health_router, tags=["Health"])

In backend/core/api.py:

1. Update health endpoint to require authentication:

Change:
```python
router = Router()

@router.get("/health")
def health_check(request):
    return {"status": "ok", "service": "venezuelawatch"}
```

To:
```python
from allauth.headless.contrib.ninja.security import jwt_token_auth

router = Router()

@router.get("/health", auth=jwt_token_auth)
def health_check(request):
    """Health check endpoint (requires authentication)."""
    return {
        "status": "ok",
        "service": "venezuelawatch",
        "user": request.auth.email  # Show authenticated user
    }
```

This demonstrates the protected endpoint pattern:
- Public endpoints: no auth parameter
- Protected endpoints: auth=jwt_token_auth

Final API structure:
- GET /api/health/health (protected) - Health check
- GET /api/user/me (protected) - User profile
- GET /api/docs (public) - OpenAPI documentation

Why protect health endpoint:
- Demonstrates authentication pattern
- In production, health checks often show internal state
- Can make public later if needed (just remove auth param)

Do NOT add authentication to /api/docs - OpenAPI docs should remain public for development.
  </action>
  <verify>
grep "api.add_router(\"/user\", user_router" backend/venezuelawatch/api.py exists
grep "auth=jwt_token_auth" backend/core/api.py shows at least 2 occurrences (health and user endpoints)
python backend/manage.py check shows no errors
  </verify>
  <done>User router mounted at /api/user/. Health endpoint protected with jwt_token_auth. API structure clean with protected endpoints clearly marked.</done>
</task>

<task type="auto">
  <name>Task 3: Test protected endpoints and verify authentication flow</name>
  <files>None (testing only)</files>
  <action>
Start Django development server:
```bash
cd backend
python manage.py runserver
```

In a new terminal, test the authentication flow:

1. **Test unauthenticated access (should fail with 401):**
```bash
curl http://localhost:8000/api/health/health
# Expected: 401 Unauthorized

curl http://localhost:8000/api/user/me
# Expected: 401 Unauthorized
```

2. **Register a test user:**
```bash
curl -X POST http://localhost:8000/_allauth/auth/registration/ \
  -H "Content-Type: application/json" \
  -d '{"email":"testuser@venezuelawatch.com","password":"secure123Pass","password_confirm":"secure123Pass"}' \
  -c cookies.txt -v
# Expected: 201 Created with Set-Cookie headers
# Check cookies.txt has tokens
```

3. **Access protected endpoints with cookies:**
```bash
# Health check with auth
curl http://localhost:8000/api/health/health -b cookies.txt
# Expected: {"status":"ok","service":"venezuelawatch","user":"testuser@venezuelawatch.com"}

# User profile
curl http://localhost:8000/api/user/me -b cookies.txt
# Expected: {"id":1,"email":"testuser@venezuelawatch.com","organization_name":"","role":"individual",...}
```

4. **Check OpenAPI documentation:**
```bash
# Visit http://localhost:8000/api/docs
# Should show lock icons on protected endpoints
# Should show "User Profile" tag for /user/me
# Should show "Health" tag for /health/health
```

5. **Test with Bearer token in header (alternative to cookies):**
```bash
# Extract access token from login response (if needed)
TOKEN=$(curl -X POST http://localhost:8000/_allauth/auth/login/ \
  -H "Content-Type: application/json" \
  -d '{"email":"testuser@venezuelawatch.com","password":"secure123Pass"}' \
  -s | grep -o '"access":"[^"]*"' | cut -d'"' -f4)

# Use token in Authorization header
curl http://localhost:8000/api/user/me \
  -H "Authorization: Bearer $TOKEN"
# Expected: User profile data
```

Verification success criteria:
- Unauthenticated requests to protected endpoints return 401
- Authenticated requests (with cookies) return 200 with data
- User profile shows correct fields from User model
- Health check shows authenticated user's email
- OpenAPI docs show lock icons on protected endpoints

If any test fails:
- Check Django logs for errors
- Verify CORS_ALLOW_CREDENTIALS = True in settings
- Verify cookies.txt has tokens (should have access_token and refresh_token)
- Verify JWT configuration in SIMPLE_JWT settings

Do NOT create automated tests - manual curl testing is sufficient for Phase 2. Automated testing will be added in future phase.
  </action>
  <verify>
curl http://localhost:8000/api/health/health returns 401 (without auth)
curl http://localhost:8000/api/health/health -b cookies.txt returns 200 (with auth cookies)
curl http://localhost:8000/api/user/me -b cookies.txt returns user profile with team fields
  </verify>
  <done>Protected endpoints tested and working. Unauthenticated access returns 401. Authenticated access returns expected data. OpenAPI docs updated with authentication indicators.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] curl http://localhost:8000/api/health/health returns 401 (no auth)
- [ ] curl http://localhost:8000/api/user/me returns 401 (no auth)
- [ ] Registration creates user and sets cookies
- [ ] curl http://localhost:8000/api/health/health -b cookies.txt returns 200
- [ ] curl http://localhost:8000/api/user/me -b cookies.txt returns user profile
- [ ] OpenAPI docs at /api/docs show lock icons on protected endpoints
- [ ] User profile includes organization_name, role, subscription_tier fields
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Protected endpoints return 401 without authentication
- Protected endpoints return 200 with valid JWT
- User profile endpoint returns complete user data
- OpenAPI documentation updated
</success_criteria>

<output>
After completion, create `.planning/phases/02-authentication-user-management/02-03-SUMMARY.md`:

---
phase: 02-authentication-user-management
plan: 03
subsystem: api
tags: [django-ninja, jwt-auth, protected-endpoints]

requires:
  - phase: 02-01
    provides: Custom User model
  - phase: 02-02
    provides: JWT authentication endpoints at /_allauth/

provides:
  - Protected endpoint pattern with jwt_token_auth
  - User profile endpoint at /api/user/me
  - Health endpoint protected (demonstrates pattern)
  - End-to-end authentication flow tested

affects: [02-04-react-ui, future-api-endpoints]

tech-stack:
  patterns: [django-ninja protected routes with jwt_token_auth, Router-level authentication]

key-files:
  modified:
    - backend/venezuelawatch/api.py
    - backend/core/api.py

key-decisions:
  - "Protected endpoint pattern: auth=jwt_token_auth on individual endpoints"
  - "User profile at /api/user/me returns full User model data"
  - "Health endpoint protected to demonstrate authentication (can be made public later)"

---

# Plan 02-03 Summary: Protected API Routes

**[Substantive one-liner]**

## Accomplishments

- Created user profile endpoint at /api/user/me with JWT authentication
- Protected health endpoint with jwt_token_auth
- Tested end-to-end authentication flow with curl
- Verified OpenAPI docs show authentication requirements

## Files Created/Modified

### Modified:
- `backend/venezuelawatch/api.py` - Mounted user router
- `backend/core/api.py` - Created user_router, protected health endpoint

## Decisions Made

1. **Protected Endpoint Pattern**: Use `auth=jwt_token_auth` parameter on individual endpoints for clarity
2. **User Profile Endpoint**: Returns all User model fields including team-ready fields
3. **Health Endpoint Authentication**: Protected to demonstrate pattern, easily made public later if needed

## Issues Encountered

[None or describe any issues]

## Next Phase Readiness

Ready for Plan 02-04 (React Authentication UI).
- Backend authentication complete and tested
- Protected endpoints working with JWT cookies
- User profile endpoint ready for frontend consumption
- OpenAPI docs show authentication requirements

---

</output>
