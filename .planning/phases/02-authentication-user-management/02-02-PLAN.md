---
phase: 02-authentication-user-management
plan: 02
type: execute
---

<objective>
Configure django-allauth headless API endpoints for registration, login, and user management.

Purpose: Expose authentication endpoints that React frontend can consume, with JWT token generation and cookie-based authentication.
Output: Working authentication API at /_allauth/ with registration, login, logout, and user profile endpoints.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-authentication-user-management/DISCOVERY.md
@.planning/phases/02-authentication-user-management/02-01-SUMMARY.md

**Tech stack available:**
- django-allauth 0.63+ with headless mode
- djangorestframework-simplejwt for JWT
- Custom User model with team fields
- CORS configured with CORS_ALLOW_CREDENTIALS=True

**Key files:**
@backend/venezuelawatch/urls.py
@backend/venezuelawatch/settings.py

**Constraining decisions:**
- Phase 1: Django REST API at /api/ prefix
- Plan 02-01: django-allauth headless configured
- Discovery: Auth endpoints at /_allauth/ (allauth convention)
- Discovery: JWT tokens in httpOnly cookies (15-min access, 7-day refresh)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure allauth headless URLs</name>
  <files>backend/venezuelawatch/urls.py</files>
  <action>
In backend/venezuelawatch/urls.py:

1. Add import: from django.urls import include

2. Add allauth headless URLs to urlpatterns (before /api/):
   path('_allauth/', include('allauth.headless.urls')),

3. Keep existing paths:
   - path("admin/", admin.site.urls)
   - path("api/", api.urls)

Final order should be:
   - admin/
   - _allauth/  # NEW
   - api/

This exposes endpoints at:
- POST /_allauth/auth/registration/ (sign up)
- POST /_allauth/auth/login/ (sign in)
- POST /_allauth/auth/logout/ (sign out)
- GET /_allauth/auth/user/ (current user details)
- POST /_allauth/auth/password/reset/ (password reset request)

Do NOT create custom authentication views - allauth headless provides everything.
  </action>
  <verify>
grep "_allauth/" backend/venezuelawatch/urls.py exists
python backend/manage.py show_urls | grep "_allauth" shows endpoints (if django-extensions installed, otherwise skip)
  </verify>
  <done>allauth headless URLs configured at /_allauth/ prefix. Registration, login, logout endpoints available.</done>
</task>

<task type="auto">
  <name>Task 2: Configure JWT settings and test authentication endpoints</name>
  <files>backend/venezuelawatch/settings.py</files>
  <action>
In backend/venezuelawatch/settings.py:

1. Add JWT configuration for allauth (at end of file before any custom settings):

```python
# JWT Configuration for django-allauth headless
from datetime import timedelta

SIMPLE_JWT = {
    'ACCESS_TOKEN_LIFETIME': timedelta(minutes=15),
    'REFRESH_TOKEN_LIFETIME': timedelta(days=7),
    'ROTATE_REFRESH_TOKENS': True,
    'BLACKLIST_AFTER_ROTATION': False,  # Can enable with django-rest-framework-simplejwt[blacklist]
    'ALGORITHM': 'HS256',
    'SIGNING_KEY': SECRET_KEY,
    'AUTH_HEADER_TYPES': ('Bearer',),
}

# Allauth headless configuration
HEADLESS_ONLY = False  # Keep Django admin accessible
ACCOUNT_AUTHENTICATION_METHOD = 'email'  # Use email for login (not username)
ACCOUNT_EMAIL_REQUIRED = True
ACCOUNT_USERNAME_REQUIRED = False  # Email is primary identifier
ACCOUNT_USER_MODEL_USERNAME_FIELD = None  # Don't use username field
```

2. Update CORS settings to ensure auth cookies work:
   - Verify CORS_ALLOW_CREDENTIALS = True (should exist from 02-01)
   - Verify CORS_ALLOWED_ORIGINS includes "http://localhost:5173"

3. Start development server and test with curl:

```bash
cd backend
python manage.py runserver

# Test registration (in new terminal)
curl -X POST http://localhost:8000/_allauth/auth/registration/ \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"testpass123","password_confirm":"testpass123"}' \
  -c cookies.txt

# Test login
curl -X POST http://localhost:8000/_allauth/auth/login/ \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"testpass123"}' \
  -c cookies.txt

# Test user endpoint (should return user details)
curl http://localhost:8000/_allauth/auth/user/ \
  -b cookies.txt
```

Expected responses:
- Registration: 201 with Set-Cookie headers (access and refresh tokens)
- Login: 200 with Set-Cookie headers
- User endpoint: 200 with {"email":"test@example.com",...}

If curl tests fail, check for error messages. Common issues:
- CSRF token missing: allauth may require CSRF. Check CSRF_COOKIE_HTTPONLY = False in settings.
- Email backend not configured: Add EMAIL_BACKEND = 'django.core.mail.backends.console.EmailBackend' for development

Do NOT add complex authentication testing - just verify endpoints return expected status codes.
  </action>
  <verify>
grep "SIMPLE_JWT" backend/venezuelawatch/settings.py exists
grep "ACCOUNT_AUTHENTICATION_METHOD = 'email'" backend/venezuelawatch/settings.py exists
curl http://localhost:8000/_allauth/auth/user/ returns 401 (unauthorized without token)
  </verify>
  <done>JWT configured with 15-min access token and 7-day refresh token. Email-based authentication enabled. Endpoints tested with curl and returning expected status codes.</done>
</task>

<task type="auto">
  <name>Task 3: Update environment configuration and documentation</name>
  <files>backend/.env.example, backend/README.md</files>
  <action>
In backend/.env.example:

1. Add authentication configuration section:
```
# Authentication (django-allauth)
ACCOUNT_EMAIL_VERIFICATION=optional  # optional | mandatory | none
EMAIL_BACKEND=django.core.mail.backends.console.EmailBackend  # For development
# For production: django.core.mail.backends.smtp.EmailBackend
# EMAIL_HOST=smtp.sendgrid.net
# EMAIL_PORT=587
# EMAIL_USE_TLS=True
# EMAIL_HOST_USER=apikey
# EMAIL_HOST_PASSWORD=your-sendgrid-api-key
```

In backend/README.md:

1. Add Authentication section after Database Setup:

```markdown
## Authentication

VenezuelaWatch uses django-allauth with headless mode for JWT authentication.

### Endpoints

Available at `/_allauth/auth/`:
- `POST /registration/` - Create new user account
- `POST /login/` - Authenticate and receive JWT tokens
- `POST /logout/` - Invalidate tokens
- `GET /user/` - Get current user details
- `POST /password/reset/` - Request password reset

### JWT Tokens

- **Access Token**: 15-minute expiry, sent in httpOnly cookie
- **Refresh Token**: 7-day expiry, sent in httpOnly cookie
- **CSRF Protection**: Enabled for state-changing operations

### Testing Authentication

Register a user:
\`\`\`bash
curl -X POST http://localhost:8000/_allauth/auth/registration/ \
  -H "Content-Type: application/json" \
  -d '{"email":"user@example.com","password":"securepass123","password_confirm":"securepass123"}' \
  -c cookies.txt
\`\`\`

Login:
\`\`\`bash
curl -X POST http://localhost:8000/_allauth/auth/login/ \
  -H "Content-Type: application/json" \
  -d '{"email":"user@example.com","password":"securepass123"}' \
  -c cookies.txt
\`\`\`

Access protected endpoints (will be configured in next plan):
\`\`\`bash
curl http://localhost:8000/api/protected/ -b cookies.txt
\`\`\`

### Email Configuration

Development: Emails print to console (EMAIL_BACKEND=console)
Production: Configure SMTP settings in .env (see .env.example)
```

Do NOT modify existing README sections - only add the new Authentication section.
  </action>
  <verify>
grep "ACCOUNT_EMAIL_VERIFICATION" backend/.env.example exists
grep "## Authentication" backend/README.md exists
grep "/_allauth/auth/" backend/README.md exists
  </verify>
  <done>.env.example updated with email configuration. README.md has Authentication section with endpoint documentation and curl examples.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] curl http://localhost:8000/_allauth/auth/user/ returns 401 (unauthenticated)
- [ ] backend/venezuelawatch/urls.py has /_allauth/ path
- [ ] backend/venezuelawatch/settings.py has SIMPLE_JWT configuration
- [ ] backend/venezuelawatch/settings.py has ACCOUNT_AUTHENTICATION_METHOD = 'email'
- [ ] backend/.env.example has authentication configuration
- [ ] backend/README.md documents authentication endpoints
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Authentication endpoints accessible at /_allauth/
- JWT configuration complete
- Documentation updated for developers
</success_criteria>

<output>
After completion, create `.planning/phases/02-authentication-user-management/02-02-SUMMARY.md`:

---
phase: 02-authentication-user-management
plan: 02
subsystem: api
tags: [django-allauth, jwt, authentication-endpoints]

requires:
  - phase: 02-01
    provides: django-allauth headless configured, Custom User model

provides:
  - Authentication API endpoints at /_allauth/auth/
  - JWT token configuration (15-min access, 7-day refresh)
  - Email-based authentication enabled
  - Registration, login, logout, user profile endpoints

affects: [02-03-protected-routes, 02-04-react-ui]

tech-stack:
  patterns: [JWT in httpOnly cookies, Email-based authentication, allauth headless API]

key-files:
  modified:
    - backend/venezuelawatch/urls.py
    - backend/venezuelawatch/settings.py
    - backend/.env.example
    - backend/README.md

key-decisions:
  - "Email as primary authentication method (not username)"
  - "15-minute access token, 7-day refresh token for security/UX balance"
  - "Console email backend for development"

---

# Plan 02-02 Summary: Authentication Endpoints

**[Substantive one-liner]**

## Accomplishments

- Configured allauth headless URLs at /_allauth/
- Set up JWT with 15-min access and 7-day refresh tokens
- Enabled email-based authentication
- Tested registration and login endpoints with curl
- Updated documentation with authentication guide

## Files Created/Modified

### Modified:
- `backend/venezuelawatch/urls.py` - Added /_allauth/ endpoints
- `backend/venezuelawatch/settings.py` - SIMPLE_JWT config, email-based auth
- `backend/.env.example` - Email configuration template
- `backend/README.md` - Authentication section with examples

## Decisions Made

1. **Email-Based Auth**: Using email as primary identifier instead of username for better UX
2. **Token Lifetime**: 15-min access (security) + 7-day refresh (UX balance)
3. **Console Email**: Development emails to console, production SMTP in .env

## Issues Encountered

[None or describe any issues]

## Next Phase Readiness

Ready for Plan 02-03 (Protected API Routes).
- Authentication endpoints working at /_allauth/
- JWT tokens generated and sent in httpOnly cookies
- Ready to protect existing API endpoints

---

</output>
