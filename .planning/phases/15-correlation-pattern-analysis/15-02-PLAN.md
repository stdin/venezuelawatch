---
phase: 15-correlation-pattern-analysis
plan: 02
type: execute
---

<objective>
Build interactive force-directed correlation graph visualization using Reagraph for exploring relationships between entities, events, and economic data.

Purpose: Provide users with an interactive exploration tool for discovering correlation patterns. Force-directed layout reveals natural clustering of related variables. Users can filter by correlation strength, click nodes/edges for details, and drag nodes to explore the network.

Output: React correlation analysis page with variable selection, Reagraph force-directed graph visualization, filtering controls, and correlation detail views.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 15 research and context
@.planning/phases/15-correlation-pattern-analysis/15-RESEARCH.md
@.planning/phases/15-correlation-pattern-analysis/15-CONTEXT.md

# Plan 1 backend API (dependency)
@.planning/phases/15-correlation-pattern-analysis/15-01-SUMMARY.md

# Established frontend patterns
@frontend/src/pages/Dashboard.tsx
@frontend/src/pages/Entities.tsx
@frontend/src/components/ui/Card.tsx
@frontend/src/components/ui/Select.tsx

**Tech stack available:**
- React 18 + TypeScript
- Mantine UI components (MultiSelect, Select, NumberInput, Button)
- React Query for data fetching
- React Router for navigation
- Established design tokens (--color-risk-high, --mantine-color-blue-filled)

**Established patterns:**
- Mantine form components for filters (MultiSelect, Select, NumberInput)
- React Query for API integration with loading states
- Grid layouts with span={{ base: 12, md: X }} for responsive design
- Card wrapper pattern for all content containers
- Design token colors in visualizations

**Constraining decisions:**
- Phase 15 RESEARCH: Use Reagraph (not react-force-graph or D3 direct) for WebGL performance
- Phase 15 RESEARCH: Force-directed 2D layout (not 3D—harder to read)
- Phase 15 RESEARCH: Filter to top strong correlations to avoid hairball (max ~50 visible nodes)
- Phase 15 CONTEXT: Show p-values AND correlation coefficients (transparency)
- Phase 15 CONTEXT: Interactive exploration, not automatic insights (users drive analysis)
- Phase 10-13: Mantine Grid, Card, form components for consistent UI

**Backend API from Plan 1:**
- POST /api/correlation/compute/ - Returns {correlations, n_tested, n_significant, bonferroni_threshold}
- Correlation format: {source, target, correlation, p_value, p_adjusted, sample_size, warnings}
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Reagraph dependency</name>
  <files>frontend/package.json</files>
  <action>
Add Reagraph to frontend dependencies:
- reagraph@^5.0.0 (WebGL-based force-directed graph library, 92.6 benchmark score per research)

Install with `npm install reagraph`

**What to avoid:**
- Don't use react-force-graph (older, 80.3 score, less performant per research)
- Don't use Cytoscape.js (heavier, 71.6 score, overkill for this use case)
- Don't use D3.js directly (requires manual React integration, much more code)
  </action>
  <verify>
```bash
cd frontend && npm install
node -e "require('reagraph'); console.log('✓ Reagraph installed')"
```
Should print success without errors.
  </verify>
  <done>
- reagraph added to frontend/package.json dependencies
- npm install completed successfully
- Reagraph module importable
  </done>
</task>

<task type="auto">
  <name>Task 2: Create correlation graph component with Reagraph</name>
  <files>frontend/src/components/CorrelationGraph/CorrelationGraph.tsx, frontend/src/components/CorrelationGraph/index.ts</files>
  <action>
Create Reagraph force-directed graph component for correlation visualization:

**File: frontend/src/components/CorrelationGraph/CorrelationGraph.tsx**
```typescript
import React, { useMemo } from 'react';
import { GraphCanvas, GraphNode, GraphEdge } from 'reagraph';
import { Card, Slider, Text, Group, Badge, Stack } from '@mantine/core';

interface Correlation {
  source: string;
  target: string;
  correlation: number;
  p_adjusted: number;
  sample_size: number;
  warnings?: string[];
}

interface CorrelationGraphProps {
  correlations: Correlation[];
  variableLabels?: Map<string, string>;  // Map variable IDs to display labels
}

export const CorrelationGraph: React.FC<CorrelationGraphProps> = ({
  correlations,
  variableLabels = new Map()
}) => {
  const [minCorrelation, setMinCorrelation] = React.useState(0.7);
  const [selectedNode, setSelectedNode] = React.useState<string | null>(null);
  const [selectedEdge, setSelectedEdge] = React.useState<Correlation | null>(null);

  // Transform correlation data to Reagraph format
  const { nodes, edges } = useMemo(() => {
    // Filter by correlation strength
    const filtered = correlations.filter(c => Math.abs(c.correlation) >= minCorrelation);

    // Extract unique variables as nodes
    const variableSet = new Set<string>();
    filtered.forEach(c => {
      variableSet.add(c.source);
      variableSet.add(c.target);
    });

    const nodes: GraphNode[] = Array.from(variableSet).map(v => {
      const degree = filtered.filter(c => c.source === v || c.target === v).length;
      return {
        id: v,
        label: variableLabels.get(v) || v,
        // Node size based on degree centrality (number of connections)
        size: Math.max(10, degree * 3),
        // Color by variable type
        fill: v.startsWith('entity_') ? 'var(--mantine-color-blue-filled)' :
              v.endsWith('_count') ? 'var(--color-risk-high)' :
              'var(--mantine-color-grape-filled)'  // Economic indicators
      };
    });

    const edges: GraphEdge[] = filtered.map((c, i) => ({
      id: `edge-${i}`,
      source: c.source,
      target: c.target,
      label: `r=${c.correlation.toFixed(2)}`,
      // Edge color: blue for positive, red for negative correlation
      fill: c.correlation > 0 ? 'var(--mantine-color-blue-6)' : 'var(--color-risk-high)',
      // Edge thickness based on correlation strength
      size: Math.abs(c.correlation) * 5,
      data: c  // Store full correlation data for onClick
    }));

    return { nodes, edges };
  }, [correlations, minCorrelation, variableLabels]);

  return (
    <Stack gap="md">
      <Card padding="md" radius="md">
        <Group justify="space-between" mb="xs">
          <Text size="sm" fw={600}>Correlation Strength Filter</Text>
          <Badge color="blue">{nodes.length} variables, {edges.length} correlations</Badge>
        </Group>
        <Slider
          value={minCorrelation}
          onChange={setMinCorrelation}
          min={0.5}
          max={1.0}
          step={0.05}
          marks={[
            { value: 0.5, label: '0.5' },
            { value: 0.7, label: '0.7' },
            { value: 0.9, label: '0.9' }
          ]}
          label={(value) => `|r| ≥ ${value.toFixed(2)}`}
        />
        <Text size="xs" c="dimmed" mt="xs">
          Showing only correlations with absolute value above {minCorrelation.toFixed(2)}
        </Text>
      </Card>

      <Card padding="md" radius="md" style={{ height: '600px', position: 'relative' }}>
        {nodes.length === 0 ? (
          <div style={{
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            height: '100%'
          }}>
            <Text c="dimmed">No correlations above threshold. Try lowering the filter.</Text>
          </div>
        ) : (
          <GraphCanvas
            nodes={nodes}
            edges={edges}
            layoutType="forceDirected2d"
            layoutOverrides={{
              linkDistance: 150,
              nodeStrength: -800,
              clusterStrength: 0.3
            }}
            draggable
            edgeInterpolation="curved"
            sizingType="centrality"
            labelType="auto"
            onNodeClick={(node) => {
              setSelectedNode(node.id);
              setSelectedEdge(null);
            }}
            onEdgeClick={(edge) => {
              const correlation = correlations.find(
                c => (c.source === edge.source && c.target === edge.target) ||
                     (c.source === edge.target && c.target === edge.source)
              );
              if (correlation) {
                setSelectedEdge(correlation);
                setSelectedNode(null);
              }
            }}
          />
        )}
      </Card>

      {/* Detail panel for selected node or edge */}
      {selectedNode && (
        <Card padding="md" radius="md">
          <Text size="sm" fw={600} mb="xs">Variable: {variableLabels.get(selectedNode) || selectedNode}</Text>
          <Text size="xs" c="dimmed">
            Connected to {edges.filter(e => e.source === selectedNode || e.target === selectedNode).length} other variables
          </Text>
        </Card>
      )}

      {selectedEdge && (
        <Card padding="md" radius="md">
          <Text size="sm" fw={600} mb="xs">Correlation Details</Text>
          <Group gap="xs">
            <Badge color={selectedEdge.correlation > 0 ? 'blue' : 'red'}>
              r = {selectedEdge.correlation.toFixed(3)}
            </Badge>
            <Badge color="gray">
              p = {selectedEdge.p_adjusted.toExponential(2)}
            </Badge>
            <Badge color="gray">
              n = {selectedEdge.sample_size}
            </Badge>
          </Group>
          {selectedEdge.warnings && selectedEdge.warnings.length > 0 && (
            <Text size="xs" c="orange" mt="xs">
              ⚠ {selectedEdge.warnings.join('; ')}
            </Text>
          )}
        </Card>
      )}
    </Stack>
  );
};
```

**File: frontend/src/components/CorrelationGraph/index.ts**
```typescript
export { CorrelationGraph } from './CorrelationGraph';
```

**What to avoid:**
- Don't use 3D force-directed layout (harder to read per research)
- Don't show all correlations without filtering (creates hairball above ~50 nodes)
- Don't omit p-values (correlation without significance is misleading)
- Don't use custom Canvas rendering (WebGL via Reagraph is 5-10x faster)
  </action>
  <verify>
```bash
cd frontend && npm run build
```
Should compile without TypeScript errors.
  </verify>
  <done>
- CorrelationGraph component created with Reagraph GraphCanvas
- Force-directed 2D layout with draggable nodes
- Filtering slider for correlation strength threshold
- Node size based on degree centrality (number of connections)
- Edge color by positive (blue) vs negative (red) correlation
- Edge thickness by correlation strength
- Click handlers for node/edge details
- Detail panel shows r-value, p-value, sample size, warnings
- No TypeScript errors
  </done>
</task>

<task type="auto">
  <name>Task 3: Create correlation analysis page with variable selection</name>
  <files>frontend/src/pages/CorrelationAnalysis.tsx, frontend/src/App.tsx</files>
  <action>
Create correlation analysis page with variable selection and API integration:

**File: frontend/src/pages/CorrelationAnalysis.tsx**
```typescript
import React, { useState } from 'react';
import { Container, Grid, Card, Title, Text, MultiSelect, Select, NumberInput, Button, Stack, Alert } from '@mantine/core';
import { useQuery } from '@tanstack/react-query';
import { CorrelationGraph } from '../components/CorrelationGraph';

interface Variable {
  value: string;
  label: string;
  group: 'Entity Risk' | 'Economic Indicators' | 'Event Counts';
}

// Available variables for correlation analysis
const AVAILABLE_VARIABLES: Variable[] = [
  // Entity risk scores (dynamic - fetch from backend or hardcode top entities)
  { value: 'entity_pdvsa_risk', label: 'PDVSA Risk Score', group: 'Entity Risk' },
  { value: 'entity_maduro_risk', label: 'Maduro Risk Score', group: 'Entity Risk' },

  // Economic indicators from FRED
  { value: 'oil_price', label: 'WTI Oil Price', group: 'Economic Indicators' },
  { value: 'inflation', label: 'Venezuela Inflation Rate', group: 'Economic Indicators' },
  { value: 'gdp', label: 'Venezuela GDP', group: 'Economic Indicators' },
  { value: 'exchange_rate', label: 'VEF/USD Exchange Rate', group: 'Economic Indicators' },

  // Event count aggregates
  { value: 'sanctions_count', label: 'Sanctions Events/Day', group: 'Event Counts' },
  { value: 'political_count', label: 'Political Events/Day', group: 'Event Counts' },
  { value: 'humanitarian_count', label: 'Humanitarian Events/Day', group: 'Event Counts' },
];

export const CorrelationAnalysis: React.FC = () => {
  const [selectedVariables, setSelectedVariables] = useState<string[]>([]);
  const [method, setMethod] = useState<'pearson' | 'spearman'>('pearson');
  const [minEffectSize, setMinEffectSize] = useState(0.7);
  const [alpha, setAlpha] = useState(0.05);

  const { data, isLoading, error, refetch } = useQuery({
    queryKey: ['correlations', selectedVariables, method, minEffectSize, alpha],
    queryFn: async () => {
      const response = await fetch('/api/correlation/compute/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          variables: selectedVariables,
          start_date: '2024-01-01',  // TODO: Make configurable
          end_date: '2024-12-31',
          method,
          min_effect_size: minEffectSize,
          alpha
        })
      });
      if (!response.ok) throw new Error('Failed to compute correlations');
      return response.json();
    },
    enabled: selectedVariables.length >= 2  // Need at least 2 variables
  });

  // Create variable label map for graph
  const variableLabels = new Map(
    AVAILABLE_VARIABLES.map(v => [v.value, v.label])
  );

  return (
    <Container fluid>
      <Title order={1} mb="xl">Correlation & Pattern Analysis</Title>
      <Text c="dimmed" mb="lg">
        Discover relationships between entities, events, and economic data.
        Statistical significance (p &lt; α) and strong effect size (|r| ≥ threshold) required.
      </Text>

      <Grid gutter="md">
        {/* Controls column */}
        <Grid.Col span={{ base: 12, md: 4 }}>
          <Card padding="lg" radius="md">
            <Stack gap="md">
              <div>
                <Text size="sm" fw={600} mb="xs">Select Variables (min 2)</Text>
                <MultiSelect
                  data={AVAILABLE_VARIABLES}
                  value={selectedVariables}
                  onChange={setSelectedVariables}
                  searchable
                  clearable
                  placeholder="Choose variables to correlate"
                  maxDropdownHeight={300}
                />
              </div>

              <div>
                <Text size="sm" fw={600} mb="xs">Correlation Method</Text>
                <Select
                  value={method}
                  onChange={(v) => setMethod(v as 'pearson' | 'spearman')}
                  data={[
                    { value: 'pearson', label: 'Pearson (linear relationships)' },
                    { value: 'spearman', label: 'Spearman (monotonic relationships)' }
                  ]}
                />
                <Text size="xs" c="dimmed" mt={4}>
                  Pearson for linear, Spearman for ranked/ordinal data
                </Text>
              </div>

              <div>
                <Text size="sm" fw={600} mb="xs">Min Correlation Strength</Text>
                <NumberInput
                  value={minEffectSize}
                  onChange={(v) => setMinEffectSize(Number(v))}
                  min={0.5}
                  max={1.0}
                  step={0.05}
                  decimalScale={2}
                />
                <Text size="xs" c="dimmed" mt={4}>
                  Only show correlations with |r| ≥ {minEffectSize} (0.7+ = strong)
                </Text>
              </div>

              <div>
                <Text size="sm" fw={600} mb="xs">Significance Level (α)</Text>
                <NumberInput
                  value={alpha}
                  onChange={(v) => setAlpha(Number(v))}
                  min={0.01}
                  max={0.10}
                  step={0.01}
                  decimalScale={2}
                />
                <Text size="xs" c="dimmed" mt={4}>
                  P-value threshold after Bonferroni correction
                </Text>
              </div>

              <Button
                onClick={() => refetch()}
                loading={isLoading}
                disabled={selectedVariables.length < 2}
                fullWidth
              >
                Compute Correlations
              </Button>

              {data && (
                <Alert color="blue" title="Results">
                  <Text size="sm">Tested: {data.n_tested} pairs</Text>
                  <Text size="sm">Significant: {data.n_significant} pairs</Text>
                  <Text size="xs">Bonferroni threshold: p &lt; {data.bonferroni_threshold.toFixed(6)}</Text>
                </Alert>
              )}

              {error && (
                <Alert color="red" title="Error">
                  Failed to compute correlations. Check backend logs.
                </Alert>
              )}
            </Stack>
          </Card>
        </Grid.Col>

        {/* Graph column */}
        <Grid.Col span={{ base: 12, md: 8 }}>
          {!data ? (
            <Card padding="lg" radius="md" style={{ minHeight: '400px', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
              <Text c="dimmed">Select at least 2 variables and click "Compute Correlations" to begin</Text>
            </Card>
          ) : (
            <CorrelationGraph
              correlations={data.correlations}
              variableLabels={variableLabels}
            />
          )}
        </Grid.Col>
      </Grid>
    </Container>
  );
};
```

**Update frontend/src/App.tsx:**
Add correlation route to React Router:
```typescript
import { CorrelationAnalysis } from './pages/CorrelationAnalysis';

// In Routes:
<Route path="/correlation" element={<CorrelationAnalysis />} />
```

**What to avoid:**
- Don't compute correlations automatically without user action (expensive query)
- Don't show "loading" state for unauthenticated API calls (handle 401 properly)
- Don't allow correlation with < 2 variables (mathematically invalid)
- Don't omit Bonferroni threshold in UI (users need to understand significance level)
  </action>
  <verify>
Manual verification required after implementation:
1. Start backend: `python manage.py runserver`
2. Start frontend: `npm run dev`
3. Navigate to http://localhost:5173/correlation
4. Select 2+ variables
5. Click "Compute Correlations"
6. Verify graph renders with nodes and edges
7. Verify slider filters correlations
8. Verify clicking nodes/edges shows details
  </verify>
  <done>
- CorrelationAnalysis page created with variable selection
- MultiSelect for choosing variables (grouped by type)
- Method selection (Pearson/Spearman)
- NumberInput for min effect size and alpha thresholds
- React Query for API integration with loading states
- Displays n_tested, n_significant, bonferroni_threshold
- CorrelationGraph component integration
- Route added to App.tsx
- Disabled state when < 2 variables selected
- Error handling for failed API calls
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Interactive correlation analysis page with Reagraph force-directed graph visualization.

Components built:
- Backend: Django API endpoint with scipy/statsmodels correlation computation
- Frontend: Variable selection UI, Reagraph graph visualization, filtering controls
- Statistical rigor: Bonferroni correction, significance + effect size filtering, stationarity checks
  </what-built>
  <how-to-verify>
1. **Start services:**
   ```bash
   # Terminal 1 - Backend
   cd backend && python manage.py runserver

   # Terminal 2 - Frontend
   cd frontend && npm run dev
   ```

2. **Navigate to correlation page:**
   - Visit: http://localhost:5173/correlation

3. **Test variable selection:**
   - Select 2+ variables from dropdown (e.g., "WTI Oil Price" and "PDVSA Risk Score")
   - Verify button enabled when ≥ 2 variables selected
   - Click "Compute Correlations"

4. **Verify graph visualization:**
   - Graph renders with nodes (variables) and edges (correlations)
   - Nodes have labels (variable names)
   - Edges show correlation values (r=X.XX)
   - Can drag nodes around (draggable)
   - Force-directed layout creates natural clustering

5. **Test filtering:**
   - Move correlation strength slider (0.5 → 1.0)
   - Verify edges disappear as threshold increases
   - Verify node count updates in badge

6. **Test interactions:**
   - Click a node → detail panel shows variable info
   - Click an edge → detail panel shows r-value, p-value, sample size
   - Verify p-values shown in scientific notation (e.g., p=1.23e-05)

7. **Test statistical rigor:**
   - Verify "Results" alert shows:
     - "Tested: N pairs" (total pairwise comparisons)
     - "Significant: M pairs" (only those passing both tests)
     - "Bonferroni threshold: p < X.XXXXXX"
   - M should be ≤ N (filtered by significance AND effect size)

8. **Test edge cases:**
   - Select only 1 variable → button disabled
   - Set threshold very high (0.99) → "No correlations above threshold" message
   - Check browser console for errors (should be none)

9. **Visual quality:**
   - Graph fills container (600px height)
   - Design tokens used (blue/red colors, Mantine components)
   - Responsive layout (controls left, graph right on desktop)
   - No horizontal scrolling
  </how-to-verify>
  <resume-signal>Type "approved" if visualization works correctly, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] Reagraph installed and importable
- [ ] CorrelationGraph component renders force-directed layout
- [ ] Variable selection with MultiSelect works
- [ ] API integration with React Query functional
- [ ] Filtering slider updates graph dynamically
- [ ] Node and edge click handlers show details
- [ ] Statistical metadata displayed (n_tested, n_significant, bonferroni_threshold)
- [ ] Responsive layout works on mobile and desktop
- [ ] No TypeScript or console errors
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Reagraph dependency installed
- CorrelationGraph component with force-directed visualization
- Variable selection UI with Mantine components
- API integration via React Query
- Interactive filtering by correlation strength
- Node/edge detail views
- Statistical rigor displayed (Bonferroni correction, p-values)
- Human verification approved (graph works correctly in browser)
- No errors or warnings introduced
- Phase 15 complete (correlation & pattern analysis functional)
</success_criteria>

<output>
After completion, create `.planning/phases/15-correlation-pattern-analysis/15-02-SUMMARY.md`:

# Phase 15 Plan 02: Correlation Graph Visualization Summary

**Interactive force-directed correlation network: Reagraph WebGL visualization with variable selection, filtering, and statistical transparency.**

## Accomplishments

- Installed Reagraph 5.x for WebGL-based force-directed graph rendering
- Created CorrelationGraph component with draggable nodes and edge details
- Built CorrelationAnalysis page with variable selection (MultiSelect)
- Integrated Django correlation API via React Query
- Implemented filtering slider for correlation strength threshold
- Added node/edge click handlers for correlation details
- Displayed statistical metadata (n_tested, n_significant, Bonferroni threshold)
- Applied design tokens for consistent colors (blue=positive, red=negative)
- Responsive Grid layout (controls left, graph right on desktop)

## Files Created/Modified

- `frontend/package.json` - Added reagraph dependency
- `frontend/src/components/CorrelationGraph/CorrelationGraph.tsx` - Reagraph force-directed graph component
- `frontend/src/components/CorrelationGraph/index.ts` - Export
- `frontend/src/pages/CorrelationAnalysis.tsx` - Correlation analysis page
- `frontend/src/App.tsx` - Added /correlation route

## Decisions Made

- Used Reagraph (not react-force-graph or D3 direct) per research for WebGL performance
- Force-directed 2D layout (not 3D) per research guidance
- Node size based on degree centrality (number of connections)
- Edge color by positive (blue) vs negative (red) correlation
- Edge thickness by correlation strength (|r| * 5)
- Filtering slider defaults to 0.7 (strong correlations only)
- Show p-values in scientific notation for clarity
- Disabled button when < 2 variables selected (invalid operation)

## Issues Encountered

None

## Next Phase Readiness

Phase 15 (Correlation & Pattern Analysis) is **COMPLETE**:
- Backend correlation engine with scipy/statsmodels (Plan 1)
- Frontend Reagraph visualization with filtering (Plan 2)
- Statistical rigor: Bonferroni correction, significance + effect size filtering
- Interactive exploration tool for discovering relationships

Ready for Phase 16: Custom Reports & Export or other v1.2 Advanced Analytics phases.

---

*Phase: 15-correlation-pattern-analysis*
*Plan: 02 of 02*
*Completed: [execution date]*
</output>
