---
phase: 27-small-scale-end-to-end-pipeline-test-in-gcp
plan: 01
type: execute
---

<objective>
Deploy GCP serverless infrastructure (Cloud Functions, Cloud Run, Cloud Scheduler, Pub/Sub) to test environment for end-to-end pipeline validation.

Purpose: Establish the GCP infrastructure foundation required to test the complete data flow from ingestion to frontend.
Output: Deployed Cloud Functions, Cloud Run service, configured schedulers, and Pub/Sub topics operational in GCP.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-small-scale-end-to-end-pipeline-test-in-gcp/27-CONTEXT.md

# Prior work - GCP architecture design
@.planning/phases/18-gcp-native-pipeline-migration/18-03-SUMMARY.md
@docs/ARCHITECTURE.md

# Deployment automation
@scripts/cutover_to_gcp.sh
@scripts/deploy_ingestion_functions.sh

**Tech stack available:**
- Cloud Functions Gen2 for ingestion triggers
- Cloud Run for API service and internal handlers
- Cloud Scheduler with OIDC authentication
- Pub/Sub for event-driven processing
- Cloud Tasks for LLM analysis queue
- BigQuery for time-series data storage

**Established patterns:**
- OIDC authentication for Cloud Scheduler (Phase 18)
- Standalone functions with no Django dependencies (Phase 18)
- Internal API handlers with IAM authentication (Phase 18)
- BigQuery streaming inserts (Phase 14.1)

**Constraining decisions:**
- Phase 18: Deployment deferred to manual execution (safety gate)
- Phase 18: Big-bang cutover approach (not gradual)
- Phase 27: Small-scale test with 1-2 weeks GDELT data (from CONTEXT.md)
- Phase 27: Prove it works, not optimize for performance (from CONTEXT.md)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Deploy Cloud Functions for data ingestion</name>
  <files>functions/gdelt_sync/, functions/reliefweb/, functions/fred/, functions/comtrade/, functions/worldbank/, functions/sanctions/, functions/mention_tracker/</files>
  <action>Deploy all Cloud Functions to GCP using gcloud CLI. Use Gen2 runtime with appropriate memory allocations (512MB-900MB per Phase 18 decisions). Deploy functions: gdelt_sync_trigger, reliefweb_sync_trigger, fred_sync_trigger, comtrade_sync_trigger, worldbank_sync_trigger, sanctions_screening_trigger, mention_tracker_trigger. Set appropriate environment variables (GCP_PROJECT_ID, BIGQUERY_DATASET, etc.) from Secret Manager or .env.gcp file if exists. Use --no-allow-unauthenticated for security. Verify each function deploys successfully with gcloud functions list.</action>
  <verify>gcloud functions list --gen2 shows all 7 functions in ACTIVE state</verify>
  <done>All ingestion Cloud Functions deployed and operational</done>
</task>

<task type="auto">
  <name>Task 2: Deploy Cloud Run API service and configure Cloud Scheduler</name>
  <files>backend/, .gcloudignore</files>
  <action>Deploy Django Cloud Run service using gcloud run deploy. Configure with environment variables for database (Cloud SQL), BigQuery, Redis (Memorystore), and Secret Manager. Use --allow-unauthenticated for public API endpoints (authentication handled by django-allauth). Configure Cloud Scheduler jobs for periodic ingestion triggers: gdelt-sync (15 min), reliefweb-updates (daily), fred-series-sync (daily), comtrade-sync (monthly), worldbank-sync (quarterly), sanctions-screening (daily 4 AM UTC). Use OIDC authentication for scheduler â†’ Cloud Functions invocations (not API keys). Set up Pub/Sub topics: event-created, analyze-intelligence, extract-entities, calculate-risk. Create push subscriptions pointing to Cloud Run internal API handlers.</action>
  <verify>gcloud run services list shows venezuelawatch-api READY, gcloud scheduler jobs list shows 6 jobs ENABLED, gcloud pubsub topics list shows 4 topics</verify>
  <done>Cloud Run service deployed, Cloud Scheduler configured with OIDC auth, Pub/Sub topics and subscriptions operational</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete GCP infrastructure deployment (Cloud Functions, Cloud Run, Cloud Scheduler, Pub/Sub)</what-built>
  <how-to-verify>
    1. Run: gcloud functions list --gen2 --filter="state:ACTIVE" --format="table(name,state)"
    2. Run: gcloud run services list --format="table(name,status.url,status.conditions)"
    3. Run: gcloud scheduler jobs list --format="table(name,state,schedule)"
    4. Run: gcloud pubsub topics list --format="table(name)"
    5. Confirm: All functions ACTIVE, Cloud Run service shows URL, schedulers ENABLED, 4 topics exist
    6. Check logs: gcloud functions logs read gdelt_sync_trigger --limit=10 (should show no deployment errors)
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe deployment issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] All 7 Cloud Functions deployed and ACTIVE
- [ ] Cloud Run service deployed with accessible URL
- [ ] All 6 Cloud Scheduler jobs configured and ENABLED
- [ ] 4 Pub/Sub topics exist with push subscriptions
- [ ] No deployment errors in Cloud Function logs
</verification>

<success_criteria>

- All tasks completed
- Infrastructure deployment verified by user
- No errors in deployment logs
- All components showing healthy status in gcloud commands
</success_criteria>

<output>
After completion, create `.planning/phases/27-small-scale-end-to-end-pipeline-test-in-gcp/27-01-SUMMARY.md`:

# Phase 27 Plan 01: GCP Infrastructure Deployment Summary

**[One-liner describing what was deployed]**

## Accomplishments

- Deployed Cloud Functions for data ingestion
- Deployed Cloud Run API service
- Configured Cloud Scheduler jobs
- Set up Pub/Sub event bus

## Files Created/Modified

- GCP resources deployed (list key components)

## Decisions Made

[Any deployment configuration decisions, or "None"]

## Issues Encountered

[Deployment problems and resolutions, or "None"]

## Next Step

Ready for 27-02-PLAN.md (Small-Scale Data Ingestion Test)
</output>
