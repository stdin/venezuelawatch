---
phase: 05-dashboard-events-feed
plan: 03
type: execute
---

<objective>
Implement filtering controls for risk dimensions, time ranges, and severity with state persistence.

Purpose: Enable users to narrow event view by risk criteria and remember preferences across sessions.
Output: Working filter UI with risk dimension filters, time range picker, severity level filters, state persisted to localStorage and URL.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-dashboard-events-feed/05-CONTEXT.md
@.planning/phases/05-dashboard-events-feed/05-02-SUMMARY.md
@frontend/src/pages/Dashboard.tsx
@frontend/src/lib/types.ts

**Tech stack available:**
- EventFilterParams interface with all filter fields
- useRiskEvents hook accepts filters parameter
- React 19 with TypeScript
- Browser localStorage, URLSearchParams APIs

**From CONTEXT.md:**
- Essential filters: risk dimensions (sanctions, political, supply chain), time range, severity levels (SEV1-5)
- State persistence: filters stick across sessions (localStorage + URL)
- NOT including: keyword search (excluded from essential filters)

**Constraining decisions:**
- Phase 4: Event types include POLITICAL, ECONOMIC, HUMANITARIAN, TRADE
- Phase 4: Severity levels SEV1_CRITICAL through SEV5_MINIMAL
- Phase 4: Risk scores 0-100
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create FilterBar component with risk dimension and severity controls</name>
  <files>frontend/src/components/FilterBar.tsx, frontend/src/components/FilterBar.css</files>
  <action>
Create FilterBar component for dashboard:

**FilterBar.tsx props:**
- filters: EventFilterParams
- onFiltersChange: (filters: EventFilterParams) => void

**Controls to implement:**
1. **Severity multi-select** (checkboxes):
   - SEV1 (Critical), SEV2 (High), SEV3 (Medium), SEV4 (Low), SEV5 (Minimal)
   - Stores as comma-separated string for API: "SEV1_CRITICAL,SEV2_HIGH"
   - Default: all selected

2. **Risk score range** (two number inputs):
   - Min risk score (0-100)
   - Max risk score (0-100)
   - Default: min=0, max=100 (show all)

3. **Sanctions toggle** (checkbox):
   - "Show only sanctioned events"
   - Maps to has_sanctions boolean
   - Default: false (show all)

4. **Event type filter** (dropdown):
   - Options: All, Political, Economic, Humanitarian, Trade
   - Maps to event_type string
   - Default: All (undefined)

5. **Time range** (dropdown):
   - Options: Last 24h (1 day), Last week (7 days), Last month (30 days), Last 3 months (90 days)
   - Maps to days_back number
   - Default: 30 days

**Layout:**
- Horizontal bar above event list
- Filters grouped logically: Severity | Risk Range | Type | Sanctions | Time
- Clear filters button (resets to defaults)
- Collapsible on mobile (hamburger icon)

**FilterBar.css:**
- Clean, minimal styling
- Filters evenly spaced
- Clear visual separation between groups
- Checkboxes and inputs styled consistently
- Mobile: vertical stacking

On any filter change, call onFiltersChange with updated EventFilterParams object.
  </action>
  <verify>FilterBar renders, all controls work, onFiltersChange called with correct params</verify>
  <done>All filter controls functional, updates propagate to parent</done>
</task>

<task type="auto">
  <name>Task 2: Integrate FilterBar with Dashboard and useRiskEvents hook</name>
  <files>frontend/src/pages/Dashboard.tsx</files>
  <action>
Update Dashboard component to use filters:

**State management:**
- Add useState for filters: EventFilterParams (initialized with defaults or from loadFiltersFromStorage())
- Pass filters to useRiskEvents hook: useRiskEvents(filters, { pollInterval: 60000 })
- Create handleFiltersChange function that updates state and calls saveFiltersToStorage()

**Render updates:**
- Add FilterBar component above EventList in events-panel
- Pass filters and onFiltersChange={handleFiltersChange} to FilterBar

**Helper functions (inline or extracted):**
- saveFiltersToStorage(filters): saves to localStorage as JSON, updates URL query params
- loadFiltersFromStorage(): reads from localStorage or URL query params, returns EventFilterParams or defaults
- Priority: URL query params > localStorage > defaults

Poll interval 60000ms (1 minute) for live updates matching CONTEXT.md vision.
  </action>
  <verify>Dashboard fetches events with filters, filter changes trigger re-fetch, events update</verify>
  <done>Filters integrated, events respond to filter changes, polling works</done>
</task>

<task type="auto">
  <name>Task 3: Implement state persistence with localStorage and URL sync</name>
  <files>frontend/src/lib/filterStorage.ts</files>
  <action>
Create utility module for filter persistence:

**saveFiltersToStorage(filters: EventFilterParams): void**
- Saves filters to localStorage key "dashboard-filters" as JSON
- Updates URL query params using window.history.replaceState()
- Convert EventFilterParams to URLSearchParams
- Example URL: ?severity=SEV1_CRITICAL,SEV2_HIGH&min_risk_score=50&days_back=7

**loadFiltersFromStorage(): EventFilterParams**
- Priority: URL query params > localStorage > defaults
- Parse URL query params first (window.location.search)
- If no URL params, try localStorage
- If no localStorage, return defaults
- Handle parsing errors gracefully (invalid JSON, malformed params)
- Defaults: { days_back: 30, min_risk_score: 0, max_risk_score: 100 }

**clearFiltersFromStorage(): void**
- Removes localStorage key
- Clears URL query params
- Returns to clean state

Export all functions. Add JSDoc comments. Handle edge cases (null values, parse errors).
  </action>
  <verify>Functions save/load correctly, URL updates, localStorage persists, parsing handles errors</verify>
  <done>State persistence working, filters survive page refresh, URL shareable</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Filter controls with state persistence for dashboard</what-built>
  <how-to-verify>
1. Start dev servers and visit dashboard
2. Test filter controls:
   - Change severity filters (uncheck SEV4, SEV5) - event list updates
   - Adjust risk score range (min=50, max=100) - only high-risk events shown
   - Toggle "Show only sanctioned" - filtered list updates
   - Change event type to "Political" - only political events shown
   - Change time range to "Last week" - recent events only
3. Test state persistence:
   - Set some filters (e.g., SEV1/SEV2 only, Political events, last 7 days)
   - Refresh page - filters should be preserved
   - Check URL - query params should reflect filters
   - Open URL in new tab - filters should load from URL
4. Test clear filters:
   - Click "Clear filters" button
   - All filters reset to defaults
   - URL query params cleared
5. Test live updates:
   - Wait 60 seconds with filters applied
   - Verify events refresh (check browser network tab for API call)
6. Verify filter combinations work correctly (e.g., high severity + sanctions + political type)
7. Check mobile view - filters should be accessible (collapsible or stacked)
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run build succeeds
- [ ] FilterBar component renders all controls
- [ ] Dashboard integrates FilterBar and passes filters to useRiskEvents
- [ ] Events update when filters change
- [ ] Filters persist to localStorage and URL
- [ ] Page refresh preserves filters
- [ ] URL sharing works (filters load from query params)
- [ ] Live polling works (60s interval)
- [ ] Human verification passed
</verification>

<success_criteria>
- All tasks completed
- FilterBar with severity, risk range, sanctions, event type, time range filters
- Filters integrated with Dashboard and useRiskEvents
- State persistence to localStorage and URL query params
- Filters survive page refresh
- URL shareable with filters
- Live updates every 60 seconds
- Clear filters functionality
- Human-verified filter behavior
</success_criteria>

<output>
After completion, create `.planning/phases/05-dashboard-events-feed/05-03-SUMMARY.md`:

# Phase 5 Plan 3: Filtering & Search Summary

**[One-line description of what shipped]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]
- [Key outcome 3]

## Files Created/Modified

- `frontend/src/components/FilterBar.tsx` - Filter controls component
- `frontend/src/components/FilterBar.css` - Filter bar styling
- `frontend/src/pages/Dashboard.tsx` - Integrated filters with event fetching
- `frontend/src/lib/filterStorage.ts` - State persistence utilities

## Decisions Made

[Filter defaults, persistence strategy, etc.]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 05-04-PLAN.md (Detail Panel & Trends)
</output>
