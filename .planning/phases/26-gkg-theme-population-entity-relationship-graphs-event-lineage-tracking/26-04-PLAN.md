---
phase: 26-gkg-theme-population-entity-relationship-graphs-event-lineage-tracking
plan: 04
type: execute
---

<objective>
Integrate GKG themes for context enrichment and relationship categorization.

Purpose: Populate entity relationships with GDELT GKG themes (SANCTIONS, TRADE, CIVIL_UNREST, etc.) to enable filtering and clustering by activity type - answering "WHAT types of activities connect these entities."
Output: Theme enrichment service, filtered graph API, and theme toggle UI component.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-gkg-theme-population-entity-relationship-graphs-event-lineage-tracking/26-RESEARCH.md
@.planning/phases/26-gkg-theme-population-entity-relationship-graphs-event-lineage-tracking/26-CONTEXT.md
@.planning/phases/26-gkg-theme-population-entity-relationship-graphs-event-lineage-tracking/26-03-SUMMARY.md

**Phase context:**
- GKG themes enrich event context in narratives (categorize what happened)
- Clustering signal to identify thematic entity groups (all entities in OIL_EXPORT events)
- Themes help understand not just WHO is connected, but WHAT types of activities connect them

**Research findings:**
- GDELT GKG V2Themes: 2,500+ themes taxonomy (Nov 2021 update)
- Format: "THEME1,offset1,offset2;THEME2,offset3,offset4" (semicolon-separated mentions)
- World Bank taxonomy integrated (WB_1234_XYZ format)
- Phase 20 already stores GKG data in metadata.gkg_data.V2Themes

**Tech stack:**
- GKG data available from Phase 20 (stored in event metadata)
- BigQuery events have metadata JSON field with gkg_data
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create theme enricher service</name>
  <files>backend/data_pipeline/services/theme_enricher.py</files>
  <action>
Create ThemeEnricher service for parsing GKG themes:

**parse_gkg_themes(v2_themes_string: str) -> List[str]:**
- Parse GDELT V2Themes format: "THEME1,offset1,offset2;THEME2,offset3,offset4"
- Split on ';' for theme mentions
- For each mention, split on ',' and extract theme name (parts[0])
- Return list of unique theme names
- Handle empty/null strings gracefully (return empty list)

**categorize_relationship(theme_list: List[str]) -> str:**
- Map themes to relationship categories:
  - Contains 'SANCTION' or 'EMBARGO' → 'sanctions'
  - Contains 'TRADE' or 'EXPORT' → 'trade'
  - Contains 'LEADER' or 'GOV_' → 'political'
  - Contains 'UNREST' or 'PROTEST' → 'adversarial'
  - Contains 'OIL' or 'ENERGY' → 'energy'
  - Else → 'other'
- Return primary category string

**enrich_edge_with_themes(edge: Dict, event_ids: List[str]) -> Dict:**
- Fetch events by IDs from BigQuery
- Extract V2Themes from each event's metadata.gkg_data
- Parse themes using parse_gkg_themes()
- Aggregate unique themes across all connecting events
- Categorize using categorize_relationship()
- Add to edge.data: {themes: List[str], category: str}
- Return enriched edge

Follow Phase 20 GKG parsing patterns. Handle missing GKG data gracefully - not all events have GKG records.

Don't download LOOKUP-GKGTHEMES.TXT yet - simple pattern matching is sufficient for Phase 26. Full theme taxonomy lookup is future enhancement.
  </action>
  <verify>python -c "from backend.data_pipeline.services.theme_enricher import ThemeEnricher; te = ThemeEnricher(); themes = te.parse_gkg_themes('WB_1234_SANCTIONS,0,10;ECON_TRADE,15,25'); print(themes)" prints ['WB_1234_SANCTIONS', 'ECON_TRADE']</verify>
  <done>ThemeEnricher service parses GKG V2Themes format, categorizes relationships, enriches edges with theme lists and categories</done>
</task>

<task type="auto">
  <name>Task 2: Add theme filtering to graph API</name>
  <files>backend/api/views/graph.py, backend/data_pipeline/services/graph_builder.py</files>
  <action>
Update GraphBuilder and API endpoint to support theme filtering:

**GraphBuilder.build_entity_graph():**
- Add optional theme_filter parameter: Union[str, List[str], None]
- If theme_filter provided:
  - After building edges, call ThemeEnricher.enrich_edge_with_themes() for each edge
  - Filter edges where edge.data.category in theme_filter (if string) or any(cat in theme_filter for cat in categories)
  - Remove nodes that have no remaining edges (isolated nodes)
- Return graph with theme-filtered edges

**API endpoint update:**
- Add query param: theme_categories (optional comma-separated string: "sanctions,trade,energy")
- Parse into list, pass to build_entity_graph(theme_filter=categories)
- Return filtered graph

**GraphResponse schema update:**
Add optional fields to Edge:
```python
class EdgeData(Schema):
    event_ids: List[str]
    strength: int
    themes: Optional[List[str]] = None
    category: Optional[str] = None
```

Don't implement theme search/autocomplete yet - that's future enhancement. Predefined categories (sanctions, trade, political, adversarial, energy, other) are sufficient.

Handle performance: Theme enrichment requires BigQuery queries for event metadata. Only enrich if theme_filter is provided (don't enrich all edges by default).
  </action>
  <verify>curl "http://localhost:8000/api/graph/entities?theme_categories=sanctions,trade" returns graph with only sanctions/trade relationships</verify>
  <done>Graph API supports theme filtering, edges enriched with GKG themes and categories, filtered graphs show only requested relationship types</done>
</task>

<task type="auto">
  <name>Task 3: Create ThemeFilter UI component</name>
  <files>frontend/src/components/EntityGraph/ThemeFilter.tsx, frontend/src/components/EntityGraph/EntityGraph.tsx, frontend/src/pages/GraphPage.tsx</files>
  <action>
Create ThemeFilter component with toggle buttons:

**ThemeFilter.tsx:**
```tsx
import { Group, Chip } from '@mantine/core';

interface Props {
  selectedThemes: string[];
  onChange: (themes: string[]) => void;
}

const THEME_OPTIONS = [
  { value: 'sanctions', label: 'Sanctions', color: 'red' },
  { value: 'trade', label: 'Trade', color: 'blue' },
  { value: 'political', label: 'Political', color: 'violet' },
  { value: 'energy', label: 'Energy', color: 'orange' },
  { value: 'adversarial', label: 'Adversarial', color: 'grape' },
];

export const ThemeFilter = ({ selectedThemes, onChange }: Props) => {
  return (
    <Chip.Group multiple value={selectedThemes} onChange={onChange}>
      <Group gap="xs">
        {THEME_OPTIONS.map(theme => (
          <Chip key={theme.value} value={theme.value} color={theme.color}>
            {theme.label}
          </Chip>
        ))}
      </Group>
    </Chip.Group>
  );
};
```

**Update EntityGraph.tsx:**
- Add selectedThemes state
- Pass to useGraphData hook: useGraphData({ selectedThemes })
- Update fetch to include theme_categories query param

**Update GraphPage.tsx:**
- Add ThemeFilter above graph: `<ThemeFilter selectedThemes={themes} onChange={setThemes} />`
- Show active filter count: "Showing {filteredEdgeCount} relationships" when themes selected

Use Mantine Chip.Group for multi-select toggle pattern (Phase 11 patterns).

Don't add "Clear All" button yet - clicking active chips to deselect is sufficient. Keep UI minimal.
  </action>
  <verify>Visit /graph, click theme chips, graph updates to show only selected relationship categories, click again to deselect</verify>
  <done>ThemeFilter component functional, multi-select chip toggles filter graph by relationship type, graph updates dynamically on theme selection</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] GKG V2Themes parsing handles semicolon/comma delimiters correctly
- [ ] Relationship categorization maps themes to categories
- [ ] Graph API returns theme-filtered results
- [ ] ThemeFilter UI toggles update graph display
- [ ] No errors when theme data missing (graceful fallback)
- [ ] Phase 26 complete: all 4 plans executed
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- GKG themes enrich entity relationships
- Theme filtering functional in API and UI
- Graph shows relationship categories visually
- Phase 26 complete and ready for Phase 27
</success_criteria>

<output>
After completion, create `.planning/phases/26-gkg-theme-population-entity-relationship-graphs-event-lineage-tracking/26-04-SUMMARY.md`

**Phase complete - all 4 plans executed.**
</output>
