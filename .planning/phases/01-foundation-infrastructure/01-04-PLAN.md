---
phase: 01-foundation-infrastructure
plan: 04
type: execute
---

<objective>
Set up GCP infrastructure: Cloud SQL (PostgreSQL + TimescaleDB), Cloud Storage for static files, and Secret Manager for credentials.

Purpose: Establish production-ready GCP infrastructure that Django and React will deploy to in later phases.
Output: Cloud SQL instance with TimescaleDB enabled, Cloud Storage bucket configured, secrets stored in Secret Manager, local development can connect to Cloud SQL, migrations applied successfully.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-infrastructure/DISCOVERY.md
@.planning/phases/01-foundation-infrastructure/01-01-SUMMARY.md
@.planning/phases/01-foundation-infrastructure/01-02-SUMMARY.md
@.planning/phases/01-foundation-infrastructure/01-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Cloud SQL PostgreSQL instance with TimescaleDB</name>
  <files>backend/README.md, .gcloudignore</files>
  <action>
    Requires gcloud CLI installed and authenticated. Check with `gcloud auth list`.

    Set GCP project (user will provide project ID or we'll create one):
    ```bash
    # List projects or create new one
    gcloud projects list
    # If needed: gcloud projects create venezuelawatch-prod --name="VenezuelaWatch"

    # Set active project
    gcloud config set project [PROJECT_ID]

    # Enable required APIs
    gcloud services enable sqladmin.googleapis.com
    gcloud services enable secretmanager.googleapis.com
    gcloud services enable storage.googleapis.com
    ```

    Create Cloud SQL PostgreSQL 16 instance with TimescaleDB:
    ```bash
    gcloud sql instances create venezuelawatch-db \
      --database-version=POSTGRES_16 \
      --tier=db-f1-micro \
      --region=us-central1 \
      --database-flags=cloudsql.enable_pg_cron=on,cloudsql.iam_authentication=on \
      --storage-size=10GB \
      --storage-type=SSD \
      --backup-start-time=03:00

    # Note: db-f1-micro is cheapest for development, upgrade to db-custom-2-7680 or higher for production
    ```

    Create database and enable TimescaleDB extension:
    ```bash
    # Create database
    gcloud sql databases create venezuelawatch --instance=venezuelawatch-db

    # Set postgres password
    gcloud sql users set-password postgres \
      --instance=venezuelawatch-db \
      --password=[GENERATE_RANDOM_PASSWORD]

    # Connect and enable TimescaleDB
    gcloud sql connect venezuelawatch-db --user=postgres --database=venezuelawatch

    # In psql shell:
    CREATE EXTENSION IF NOT EXISTS timescaledb CASCADE;
    \q
    ```

    Create a dedicated database user (not postgres superuser):
    ```bash
    gcloud sql users create venezuelawatch_app \
      --instance=venezuelawatch-db \
      --password=[GENERATE_RANDOM_PASSWORD]

    # Grant permissions
    gcloud sql connect venezuelawatch-db --user=postgres --database=venezuelawatch

    # In psql:
    GRANT ALL PRIVILEGES ON DATABASE venezuelawatch TO venezuelawatch_app;
    GRANT ALL ON SCHEMA public TO venezuelawatch_app;
    \q
    ```

    Get Cloud SQL connection name for later use:
    ```bash
    gcloud sql instances describe venezuelawatch-db --format="value(connectionName)"
    # Format: PROJECT_ID:REGION:INSTANCE_NAME
    ```

    Update backend/README.md with Cloud SQL connection instructions:
    - Install cloud-sql-proxy
    - Connection string format for Cloud SQL
    - How to connect from local development

    Create .gcloudignore file at root:
    ```
    .git
    .gitignore
    __pycache__/
    *.pyc
    .env
    .venv/
    venv/
    node_modules/
    .planning/
    frontend/node_modules/
    frontend/dist/
    backend/db.sqlite3
    ```
  </action>
  <verify>
    `gcloud sql instances list` shows venezuelawatch-db in RUNNABLE state. `gcloud sql databases list --instance=venezuelawatch-db` shows venezuelawatch database. Connection name captured.
  </verify>
  <done>Cloud SQL PostgreSQL 16 instance created with TimescaleDB extension enabled, dedicated app user created.</done>
</task>

<task type="auto">
  <name>Task 2: Configure Cloud Storage bucket for static files</name>
  <files>backend/requirements.txt, backend/venezuelawatch/settings.py</files>
  <action>
    Create Cloud Storage bucket for static files:
    ```bash
    # Create bucket (must be globally unique)
    gsutil mb -l us-central1 gs://venezuelawatch-static

    # Set public read access for static files
    gsutil iam ch allUsers:objectViewer gs://venezuelawatch-static

    # Enable CORS for frontend
    echo '[{"origin": ["*"], "method": ["GET"], "maxAgeSeconds": 3600}]' > cors.json
    gsutil cors set cors.json gs://venezuelawatch-static
    rm cors.json
    ```

    Add django-storages and google-cloud-storage to backend/requirements.txt:
    ```
    django-storages[google]>=1.14
    google-cloud-storage>=2.10
    ```

    Update backend/venezuelawatch/settings.py for static files:
    ```python
    # Static files configuration
    STATIC_URL = '/static/'
    STATIC_ROOT = os.path.join(BASE_DIR, 'staticfiles')

    # For production with GCS (enable when USE_GCS=true in environment)
    USE_GCS = os.getenv('USE_GCS', 'false').lower() == 'true'

    if USE_GCS:
        DEFAULT_FILE_STORAGE = 'storages.backends.gcloud.GoogleCloudStorage'
        STATICFILES_STORAGE = 'storages.backends.gcloud.GoogleCloudStorage'
        GS_BUCKET_NAME = 'venezuelawatch-static'
        GS_DEFAULT_ACL = 'publicRead'
        STATIC_URL = f'https://storage.googleapis.com/{GS_BUCKET_NAME}/'
    ```
  </action>
  <verify>
    `gsutil ls` shows gs://venezuelawatch-static/. django-storages and google-cloud-storage in requirements.txt. Settings updated with GCS configuration.
  </verify>
  <done>Cloud Storage bucket created with public read access, django-storages configured for static file hosting.</done>
</task>

<task type="auto">
  <name>Task 3: Set up Secret Manager and apply database migrations</name>
  <files>backend/.env.example, backend/README.md</files>
  <action>
    Store secrets in Secret Manager:
    ```bash
    # Django SECRET_KEY (generate random 50-char string)
    echo -n "$(python -c 'from django.core.management.utils import get_random_secret_key; print(get_random_secret_key())')" | \
      gcloud secrets create django-secret-key --data-file=-

    # Database URL (use app user credentials from Task 1)
    echo -n "postgresql://venezuelawatch_app:[APP_USER_PASSWORD]@/venezuelawatch?host=/cloudsql/[CONNECTION_NAME]" | \
      gcloud secrets create database-url --data-file=-

    # Database password separately (for rotation)
    echo -n "[APP_USER_PASSWORD]" | \
      gcloud secrets create db-password --data-file=-
    ```

    Test local connection to Cloud SQL using cloud-sql-proxy:
    ```bash
    # Install cloud-sql-proxy if not already
    # Download from https://cloud.google.com/sql/docs/postgres/sql-proxy

    # Start proxy in background
    cloud-sql-proxy [CONNECTION_NAME] &

    # Update local .env to use Cloud SQL:
    # DATABASE_URL=postgresql://venezuelawatch_app:[PASSWORD]@localhost:5432/venezuelawatch
    ```

    Apply Django migrations to Cloud SQL:
    ```bash
    cd backend

    # Export DATABASE_URL for Cloud SQL
    export DATABASE_URL="postgresql://venezuelawatch_app:[PASSWORD]@localhost:5432/venezuelawatch"

    # Run migrations (including TimescaleDB hypertable creation)
    python manage.py migrate

    # Create Django superuser for admin access
    python manage.py createsuperuser
    ```

    Verify TimescaleDB hypertable created:
    ```bash
    gcloud sql connect venezuelawatch-db --user=venezuelawatch_app --database=venezuelawatch

    # In psql:
    SELECT * FROM timescaledb_information.hypertables;
    # Should show events table as hypertable
    \q
    ```

    Update backend/README.md with:
    - Secret Manager access instructions
    - Cloud SQL connection via cloud-sql-proxy
    - How to apply migrations to Cloud SQL
    - Verifying TimescaleDB hypertable

    Update .env.example with:
    ```
    # Local Development
    DATABASE_URL=postgresql://user:password@localhost:5432/venezuelawatch
    SECRET_KEY=your-secret-key-here
    DEBUG=True
    USE_GCS=False

    # Production (Cloud Run) - use Secret Manager
    # DATABASE_URL=secretmanager://database-url
    # SECRET_KEY=secretmanager://django-secret-key
    # DEBUG=False
    # USE_GCS=True
    ```
  </action>
  <verify>
    `gcloud secrets list` shows django-secret-key, database-url, db-password. `python backend/manage.py migrate --check` passes. Query TimescaleDB hypertables shows events table. Django admin accessible with superuser.
  </verify>
  <done>Secrets stored in Secret Manager, migrations applied to Cloud SQL, TimescaleDB hypertable verified, Django superuser created.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Cloud SQL instance running and accessible
- [ ] TimescaleDB extension enabled in PostgreSQL
- [ ] events table exists as TimescaleDB hypertable
- [ ] Cloud Storage bucket created with public read access
- [ ] Secrets stored in Secret Manager (SECRET_KEY, DATABASE_URL, DB_PASSWORD)
- [ ] Django migrations applied successfully to Cloud SQL
- [ ] Django superuser created
- [ ] cloud-sql-proxy can connect from local machine
- [ ] Documentation updated with GCP setup instructions
</verification>

<success_criteria>
- Cloud SQL PostgreSQL instance operational with TimescaleDB
- Database migrations applied successfully
- TimescaleDB hypertable created and verified
- Cloud Storage bucket configured for static files
- Secrets securely stored in Secret Manager
- Local development can connect to Cloud SQL
- Phase 1 complete: Foundation & Infrastructure ready
- All verification checks pass
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-infrastructure/01-04-SUMMARY.md`
</output>
