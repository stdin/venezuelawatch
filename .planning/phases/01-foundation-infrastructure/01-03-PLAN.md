---
phase: 01-foundation-infrastructure
plan: 03
type: execute
---

<objective>
Configure PostgreSQL database with TimescaleDB extension and create Event model schema.

Purpose: Establish the database foundation optimized for time-series event data that the data pipeline will populate.
Output: Event model created, TimescaleDB hypertable configured, migrations applied, database ready for event ingestion.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-infrastructure/DISCOVERY.md
@.planning/phases/01-foundation-infrastructure/01-01-SUMMARY.md
@.planning/phases/01-foundation-infrastructure/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure PostgreSQL database in Django settings</name>
  <files>backend/venezuelawatch/settings.py, backend/.env.example, backend/requirements.txt</files>
  <action>
    Add dj-database-url to backend/requirements.txt for PostgreSQL URL parsing.

    Update backend/venezuelawatch/settings.py DATABASES configuration:
    ```python
    import dj_database_url

    # Database configuration
    # Use DATABASE_URL from environment, fallback to SQLite for initial setup
    DATABASES = {
        'default': dj_database_url.config(
            default='sqlite:///db.sqlite3',
            conn_max_age=600,
            conn_health_checks=True,
        )
    }
    ```

    Update backend/.env.example to include:
    ```
    # Development (local PostgreSQL)
    DATABASE_URL=postgresql://user:password@localhost:5432/venezuelawatch

    # Production (Cloud SQL) - will be configured in Plan 04
    # DATABASE_URL=postgresql://user:password@/venezuelawatch?host=/cloudsql/PROJECT:REGION:INSTANCE
    ```

    Install timescaledb-python package: Add `timescaledb==0.1.*` to requirements.txt for TimescaleDB support.

    Note: For local development, PostgreSQL with TimescaleDB extension must be installed separately. Instructions in README.
  </action>
  <verify>
    `python backend/manage.py check` passes. requirements.txt includes dj-database-url and timescaledb. .env.example has DATABASE_URL template.
  </verify>
  <done>PostgreSQL database configuration complete with environment-based connection.</done>
</task>

<task type="auto">
  <name>Task 2: Create Event model with TimescaleDB schema</name>
  <files>backend/core/models.py, backend/core/admin.py</files>
  <action>
    Create Event model in backend/core/models.py:
    ```python
    import uuid
    from django.db import models
    from django.contrib.postgres.fields import ArrayField
    from django.utils import timezone

    class Event(models.Model):
        """
        Time-series event data from multiple sources.
        Will be converted to TimescaleDB hypertable partitioned by timestamp.
        """
        # Primary key
        id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)

        # Event metadata
        source = models.CharField(
            max_length=50,
            db_index=True,
            help_text="Data source: GDELT, FRED, UN_COMTRADE, WORLD_BANK, RELIEFWEB, USITC, PORT_AUTHORITIES"
        )
        event_type = models.CharField(
            max_length=50,
            db_index=True,
            help_text="Category: POLITICAL, ECONOMIC, TRADE, NATURAL_RESOURCE, TARIFF, DISASTER, etc."
        )

        # Time dimension (hypertable partition key)
        timestamp = models.DateTimeField(
            default=timezone.now,
            db_index=True,
            help_text="Event occurrence time (UTC)"
        )

        # Event content
        title = models.CharField(max_length=500)
        content = models.JSONField(
            help_text="Flexible event data structure varying by source"
        )

        # Analysis fields (populated by Phase 4-6)
        entities = ArrayField(
            models.CharField(max_length=200),
            blank=True,
            default=list,
            help_text="Extracted entities: people, companies, governments"
        )
        sentiment = models.FloatField(
            null=True,
            blank=True,
            help_text="Sentiment score from -1 (negative) to 1 (positive)"
        )
        risk_score = models.FloatField(
            null=True,
            blank=True,
            db_index=True,
            help_text="Computed risk level (0-100)"
        )

        # Record metadata
        created_at = models.DateTimeField(auto_now_add=True)
        updated_at = models.DateTimeField(auto_now=True)

        class Meta:
            db_table = 'events'
            ordering = ['-timestamp']
            indexes = [
                models.Index(fields=['-timestamp', 'source']),
                models.Index(fields=['-timestamp', 'event_type']),
                models.Index(fields=['-timestamp', 'risk_score']),
            ]

        def __str__(self):
            return f"{self.source} - {self.title[:50]}"
    ```

    Register model in backend/core/admin.py for Django admin:
    ```python
    from django.contrib import admin
    from .models import Event

    @admin.register(Event)
    class EventAdmin(admin.ModelAdmin):
        list_display = ['timestamp', 'source', 'event_type', 'title', 'risk_score']
        list_filter = ['source', 'event_type', 'timestamp']
        search_fields = ['title', 'content']
        readonly_fields = ['id', 'created_at', 'updated_at']
        date_hierarchy = 'timestamp'
    ```
  </action>
  <verify>
    `python backend/manage.py check` passes with no errors. Event model validates.
  </verify>
  <done>Event model created with TimescaleDB-ready schema including time partitioning fields.</done>
</task>

<task type="auto">
  <name>Task 3: Create migration and prepare for TimescaleDB hypertable</name>
  <files>backend/core/migrations/0001_initial.py, backend/core/migrations/0002_create_hypertable.py, backend/README.md</files>
  <action>
    Run `python backend/manage.py makemigrations` to create initial migration for Event model.

    Create a data migration backend/core/migrations/0002_create_hypertable.py:
    ```python
    from django.db import migrations

    class Migration(migrations.Migration):
        dependencies = [
            ('core', '0001_initial'),
        ]

        operations = [
            migrations.RunSQL(
                # Create TimescaleDB hypertable (requires TimescaleDB extension)
                sql="""
                    -- Enable TimescaleDB extension (must be done by superuser in Cloud SQL)
                    -- CREATE EXTENSION IF NOT EXISTS timescaledb CASCADE;

                    -- Convert events table to hypertable partitioned by timestamp
                    -- Chunk interval: 7 days (good for event data)
                    SELECT create_hypertable('events', 'timestamp',
                        chunk_time_interval => INTERVAL '7 days',
                        if_not_exists => TRUE
                    );

                    -- Create compression policy (compress data older than 7 days)
                    SELECT add_compression_policy('events', INTERVAL '7 days');

                    -- Create retention policy (drop data older than 6 months for now)
                    SELECT add_retention_policy('events', INTERVAL '6 months');
                """,
                reverse_sql="""
                    SELECT remove_retention_policy('events');
                    SELECT remove_compression_policy('events');
                    -- Note: Cannot easily reverse create_hypertable
                """
            ),
        ]
    ```

    Update backend/README.md with PostgreSQL + TimescaleDB setup instructions:
    ```markdown
    ## Local Database Setup

    ### Option 1: Docker (Recommended)
    ```bash
    docker run -d --name timescaledb -p 5432:5432 \
      -e POSTGRES_PASSWORD=password \
      -e POSTGRES_DB=venezuelawatch \
      timescale/timescaledb-ha:pg16
    ```

    ### Option 2: Local PostgreSQL + TimescaleDB
    - Install PostgreSQL 16
    - Install TimescaleDB extension: https://docs.timescale.com/install/
    - Create database: `createdb venezuelawatch`
    - Enable extension: `psql venezuelawatch -c "CREATE EXTENSION IF NOT EXISTS timescaledb"`

    ### Run Migrations
    ```bash
    cd backend
    python manage.py migrate
    ```

    Note: Migration 0002 requires TimescaleDB extension. For testing without TimescaleDB, you can skip it temporarily and use regular PostgreSQL table (not recommended for production).
    ```

    DO NOT run migrations yet - will be done during Plan 04 when database is ready.
  </action>
  <verify>
    `ls backend/core/migrations/` shows 0001_initial.py and 0002_create_hypertable.py. README updated with database setup instructions.
  </verify>
  <done>Migrations created for Event model and TimescaleDB hypertable configuration, ready to apply when database is available.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `python backend/manage.py check` passes
- [ ] Event model defined with all required fields
- [ ] Migration 0001_initial.py exists
- [ ] Migration 0002_create_hypertable.py exists with TimescaleDB SQL
- [ ] Django admin registered for Event model
- [ ] README.md updated with database setup instructions
- [ ] dj-database-url in requirements.txt
</verification>

<success_criteria>
- PostgreSQL configuration complete
- Event model created with time-series optimized schema
- TimescaleDB hypertable migration prepared
- Database setup documentation complete
- All verification checks pass
- Migrations ready to apply (will run in Plan 04)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-infrastructure/01-03-SUMMARY.md`
</output>
