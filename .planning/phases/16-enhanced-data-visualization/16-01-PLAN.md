---
phase: 16-enhanced-data-visualization
plan: 01
type: execute
---

<objective>
Expand visualization capabilities with heatmaps, interactive timeline charts, and comparison views using existing Recharts/Mantine patterns.

Purpose: Provide deeper analytical views for temporal patterns, multi-entity comparisons, and correlation matrices. Extends existing Recharts patterns established in Phases 10-14 with no new libraries.

Output: Three new visualization components (heatmap, risk event timeline, entity comparison chart) integrated into existing pages.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Established chart patterns
@frontend/src/components/charts/RiskTrendChart.tsx
@frontend/src/components/forecasting/EntityForecastChart.tsx
@frontend/src/components/CorrelationGraph/CorrelationGraph.tsx

# Current Dashboard usage
@frontend/src/pages/Dashboard.tsx
@frontend/src/pages/Entities.tsx
@frontend/src/pages/CorrelationAnalysis.tsx

**Tech stack available:**
- Recharts (Line, Area, ComposedChart, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer)
- Reagraph (force-directed graphs - Phase 15)
- Mantine UI (Card, Grid, Select, SegmentedControl, Slider, Badge, Text, Stack, Group)
- React Query for data fetching
- date-fns for date formatting
- Design tokens (--color-risk-high, --mantine-color-blue-filled, etc.)

**Established patterns:**
- Recharts ResponsiveContainer with width="100%" height={300}
- Design token colors in stroke/fill properties
- Mantine Card wrapper pattern for all charts
- Tooltip with custom contentStyle matching theme
- XAxis tickFormatter with date-fns format()
- Loading states with Mantine Skeleton
- Error states with Mantine Alert

**Constraining decisions:**
- Phase 10: Recharts for all time-series visualizations (not D3, not Chart.js)
- Phase 10: Design token colors in charts for theme consistency
- Phase 10: Mantine Card wrapper pattern for all chart containers
- Phase 10: ResponsiveContainer for fluid layouts
- Phase 13: Responsive breakpoints (xs: 36em, sm: 48em, md: 62em)
- Phase 15: Reagraph for network graphs (correlation visualization)

**No new dependencies needed** - extend existing Recharts/Mantine patterns only.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create correlation matrix heatmap component</name>
  <files>frontend/src/components/charts/CorrelationHeatmap.tsx, frontend/src/components/charts/CorrelationHeatmap.module.css</files>
  <action>
Create heatmap visualization for correlation matrices using CSS Grid (not a heavy library).

**File: frontend/src/components/charts/CorrelationHeatmap.tsx**
```typescript
import React from 'react';
import { Card, Text, Tooltip as MantineTooltip } from '@mantine/core';
import styles from './CorrelationHeatmap.module.css';

interface Correlation {
  source: string;
  target: string;
  correlation: number;
  p_adjusted: number;
}

interface CorrelationHeatmapProps {
  correlations: Correlation[];
  variableLabels?: Map<string, string>;
}

export const CorrelationHeatmap: React.FC<CorrelationHeatmapProps> = ({
  correlations,
  variableLabels = new Map()
}) => {
  // Extract unique variables (sorted alphabetically)
  const variables = Array.from(
    new Set(correlations.flatMap(c => [c.source, c.target]))
  ).sort();

  // Build correlation lookup matrix (symmetric)
  const correlationMap = new Map<string, number>();
  correlations.forEach(c => {
    correlationMap.set(`${c.source}-${c.target}`, c.correlation);
    correlationMap.set(`${c.target}-${c.source}`, c.correlation);
  });

  // Get correlation value (symmetric)
  const getCorrelation = (row: string, col: string): number | null => {
    if (row === col) return 1.0;  // Perfect self-correlation
    return correlationMap.get(`${row}-${col}`) ?? null;
  };

  // Color scale: -1 (red) to 0 (white) to +1 (blue)
  const getColor = (value: number | null): string => {
    if (value === null) return 'var(--mantine-color-gray-2)';
    const intensity = Math.abs(value);
    const alpha = 0.1 + intensity * 0.6;  // 0.1 to 0.7
    return value > 0
      ? `rgba(37, 99, 235, ${alpha})`  // Blue (positive)
      : `rgba(220, 38, 38, ${alpha})`;  // Red (negative)
  };

  return (
    <Card padding="md" radius="md">
      <Text size="sm" fw={600} mb="md">Correlation Matrix Heatmap</Text>
      <div className={styles.heatmapContainer}>
        <div
          className={styles.grid}
          style={{
            gridTemplateColumns: `120px repeat(${variables.length}, 1fr)`,
            gridTemplateRows: `30px repeat(${variables.length}, 1fr)`
          }}
        >
          {/* Top-left empty cell */}
          <div className={styles.cellEmpty} />

          {/* Column headers */}
          {variables.map(v => (
            <MantineTooltip key={`col-${v}`} label={variableLabels.get(v) || v}>
              <div className={styles.cellHeader}>
                {(variableLabels.get(v) || v).slice(0, 12)}
              </div>
            </MantineTooltip>
          ))}

          {/* Rows */}
          {variables.map(rowVar => (
            <React.Fragment key={`row-${rowVar}`}>
              {/* Row header */}
              <MantineTooltip label={variableLabels.get(rowVar) || rowVar}>
                <div className={styles.cellHeader}>
                  {(variableLabels.get(rowVar) || rowVar).slice(0, 15)}
                </div>
              </MantineTooltip>

              {/* Data cells */}
              {variables.map(colVar => {
                const value = getCorrelation(rowVar, colVar);
                return (
                  <MantineTooltip
                    key={`${rowVar}-${colVar}`}
                    label={
                      value !== null
                        ? `${variableLabels.get(rowVar) || rowVar} × ${variableLabels.get(colVar) || colVar}: r=${value.toFixed(3)}`
                        : 'No data'
                    }
                  >
                    <div
                      className={styles.cell}
                      style={{ backgroundColor: getColor(value) }}
                    >
                      {value !== null ? value.toFixed(2) : '—'}
                    </div>
                  </MantineTooltip>
                );
              })}
            </React.Fragment>
          ))}
        </div>

        <div className={styles.legend}>
          <Text size="xs" c="dimmed">Correlation:</Text>
          <div className={styles.legendBar}>
            <span className={styles.legendLabel}>-1.0 (strong negative)</span>
            <div className={styles.legendGradient} />
            <span className={styles.legendLabel}>+1.0 (strong positive)</span>
          </div>
        </div>
      </div>
    </Card>
  );
};
```

**File: frontend/src/components/charts/CorrelationHeatmap.module.css**
```css
.heatmapContainer {
  max-width: 100%;
  overflow-x: auto;
}

.grid {
  display: grid;
  gap: 1px;
  background-color: var(--mantine-color-gray-3);
  border: 1px solid var(--mantine-color-gray-3);
}

.cellEmpty {
  background-color: var(--mantine-color-gray-1);
}

.cellHeader {
  background-color: var(--mantine-color-gray-1);
  padding: 4px 8px;
  font-size: 11px;
  font-weight: 600;
  text-overflow: ellipsis;
  overflow: hidden;
  white-space: nowrap;
  display: flex;
  align-items: center;
  color: var(--mantine-color-text);
}

.cell {
  background-color: white;
  padding: 8px;
  font-size: 12px;
  font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
  text-align: center;
  cursor: pointer;
  transition: transform 0.1s ease;
  min-height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.cell:hover {
  transform: scale(1.05);
  z-index: 1;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
}

.legend {
  margin-top: 16px;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.legendBar {
  display: flex;
  align-items: center;
  gap: 12px;
}

.legendGradient {
  flex: 1;
  height: 20px;
  background: linear-gradient(
    to right,
    rgba(220, 38, 38, 0.7),
    rgba(255, 255, 255, 0.1),
    rgba(37, 99, 235, 0.7)
  );
  border: 1px solid var(--mantine-color-gray-3);
  border-radius: 4px;
}

.legendLabel {
  font-size: 11px;
  color: var(--mantine-color-dimmed);
}
```

**What to avoid:**
- Don't use D3 heatmap (overkill, requires SVG + scales)
- Don't use Victory or Nivo heatmap (new dependencies)
- Don't use Recharts Treemap (wrong chart type, poor for correlation matrices)
- CSS Grid is sufficient for rectangular heatmaps and matches our existing stack
  </action>
  <verify>
```bash
cd frontend && npm run build
```
Should compile without errors. No new dependencies added.
  </verify>
  <done>
- CorrelationHeatmap component created with CSS Grid layout
- Color scale from red (negative) to blue (positive correlation)
- Symmetric matrix (correlation is bidirectional)
- Diagonal shows 1.0 (perfect self-correlation)
- Hover tooltips with Mantine Tooltip
- Responsive with horizontal scroll for large matrices
- Legend with gradient scale
- No TypeScript errors
- No new dependencies
  </done>
</task>

<task type="auto">
  <name>Task 2: Create risk event timeline combo chart</name>
  <files>frontend/src/components/charts/RiskEventTimeline.tsx</files>
  <action>
Create combined timeline visualization showing risk scores with overlaid event markers using Recharts ComposedChart (pattern established in EntityForecastChart).

**File: frontend/src/components/charts/RiskEventTimeline.tsx**
```typescript
import React from 'react';
import { Card, Text, Badge, Stack, Group } from '@mantine/core';
import { ResponsiveContainer, ComposedChart, Line, Scatter, XAxis, YAxis, CartesianGrid, Tooltip, Legend } from 'recharts';
import { format, parseISO } from 'date-fns';

interface Event {
  date: string;
  event_type: string;
  severity: string;
  title: string;
  risk_score?: number;
}

interface RiskEventTimelineProps {
  riskData: Array<{ date: string; risk_score: number }>;
  events: Event[];
  title?: string;
}

export const RiskEventTimeline: React.FC<RiskEventTimelineProps> = ({
  riskData,
  events,
  title = 'Risk Score & Events Timeline'
}) => {
  // Merge risk data and events by date
  const chartData = riskData.map(d => {
    const dayEvents = events.filter(e => e.date === d.date);
    return {
      date: d.date,
      risk_score: d.risk_score,
      // Mark severe events for scatter plot
      event_marker: dayEvents.length > 0 ? d.risk_score : null,
      event_count: dayEvents.length,
      events: dayEvents
    };
  });

  // Custom tooltip showing both risk score and events
  const CustomTooltip = ({ active, payload }: any) => {
    if (!active || !payload || !payload.length) return null;

    const data = payload[0].payload;
    return (
      <div style={{
        backgroundColor: 'var(--mantine-color-body)',
        border: '1px solid var(--mantine-color-gray-3)',
        borderRadius: '4px',
        padding: '8px 12px'
      }}>
        <Text size="sm" fw={600} mb={4}>
          {format(parseISO(data.date), 'MMM dd, yyyy')}
        </Text>
        <Text size="sm">
          Risk Score: <strong>{data.risk_score?.toFixed(1)}</strong>
        </Text>
        {data.events && data.events.length > 0 && (
          <Stack gap={4} mt={8}>
            <Text size="xs" fw={600}>Events ({data.events.length}):</Text>
            {data.events.slice(0, 3).map((e: Event, i: number) => (
              <Group key={i} gap={4}>
                <Badge size="xs" color={
                  e.severity === 'SEV1' ? 'red' :
                  e.severity === 'SEV2' ? 'orange' :
                  e.severity === 'SEV3' ? 'yellow' : 'gray'
                }>
                  {e.event_type}
                </Badge>
                <Text size="xs" lineClamp={1}>{e.title}</Text>
              </Group>
            ))}
            {data.events.length > 3 && (
              <Text size="xs" c="dimmed">+{data.events.length - 3} more</Text>
            )}
          </Stack>
        )}
      </div>
    );
  };

  return (
    <Card padding="md" radius="md">
      <Text size="sm" fw={600} mb="md">{title}</Text>
      <ResponsiveContainer width="100%" height={350}>
        <ComposedChart data={chartData} margin={{ top: 10, right: 30, left: 0, bottom: 0 }}>
          <CartesianGrid strokeDasharray="3 3" stroke="var(--mantine-color-gray-3)" />
          <XAxis
            dataKey="date"
            tickFormatter={(date) => format(parseISO(date), 'MMM dd')}
            stroke="var(--mantine-color-gray-6)"
          />
          <YAxis
            domain={[0, 100]}
            stroke="var(--mantine-color-gray-6)"
            label={{ value: 'Risk Score', angle: -90, position: 'insideLeft' }}
          />
          <Tooltip content={<CustomTooltip />} />
          <Legend />

          {/* Risk score line */}
          <Line
            type="monotone"
            dataKey="risk_score"
            stroke="var(--mantine-color-blue-filled)"
            strokeWidth={2}
            dot={false}
            name="Risk Score"
          />

          {/* Event markers (scatter points on days with events) */}
          <Scatter
            dataKey="event_marker"
            fill="var(--color-risk-high)"
            shape="circle"
            name="Events"
          />
        </ComposedChart>
      </ResponsiveContainer>
      <Text size="xs" c="dimmed" mt="xs">
        Red dots mark days with significant events. Hover for event details.
      </Text>
    </Card>
  );
};
```

**What to avoid:**
- Don't create separate Y-axis for event counts (clutters chart, use scatter instead)
- Don't use BarChart for events (obscures risk trend line)
- Don't omit custom tooltip (default tooltip won't show event details)
- ComposedChart is correct for layering Line + Scatter (established pattern from Phase 14)
  </action>
  <verify>
```bash
cd frontend && npm run build
```
Should compile without TypeScript errors.
  </verify>
  <done>
- RiskEventTimeline component created with Recharts ComposedChart
- Line chart for risk score over time
- Scatter plot overlay for event markers (red dots)
- Custom tooltip showing both risk score and event list on hover
- Event type badges with severity colors
- 350px height for better event visibility vs standard 300px
- Design token colors (--mantine-color-blue-filled, --color-risk-high)
- Pattern consistent with EntityForecastChart
- No TypeScript errors
  </done>
</task>

<task type="auto">
  <name>Task 3: Add heatmap and timeline to correlation page</name>
  <files>frontend/src/pages/CorrelationAnalysis.tsx</files>
  <action>
Integrate CorrelationHeatmap as alternative view to force-directed graph on correlation analysis page. Add SegmentedControl toggle between graph and heatmap views.

**Update frontend/src/pages/CorrelationAnalysis.tsx:**

Add imports:
```typescript
import { SegmentedControl } from '@mantine/core';
import { CorrelationHeatmap } from '../components/charts/CorrelationHeatmap';
```

Add state for view toggle (after existing state declarations):
```typescript
const [viewMode, setViewMode] = useState<'graph' | 'heatmap'>('graph');
```

Replace the graph column section (Grid.Col with correlation graph) with:
```typescript
{/* Visualization column */}
<Grid.Col span={{ base: 12, md: 8 }}>
  {!data ? (
    <Card padding="lg" radius="md" style={{ minHeight: '400px', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
      <Text c="dimmed">Select at least 2 variables and click "Compute Correlations" to begin</Text>
    </Card>
  ) : (
    <Stack gap="md">
      {/* View toggle */}
      <Card padding="md" radius="md">
        <SegmentedControl
          value={viewMode}
          onChange={(v) => setViewMode(v as 'graph' | 'heatmap')}
          data={[
            { label: 'Network Graph', value: 'graph' },
            { label: 'Heatmap Matrix', value: 'heatmap' }
          ]}
          fullWidth
        />
      </Card>

      {/* Render selected view */}
      {viewMode === 'graph' ? (
        <CorrelationGraph
          correlations={data.correlations}
          variableLabels={variableLabels}
        />
      ) : (
        <CorrelationHeatmap
          correlations={data.correlations}
          variableLabels={variableLabels}
        />
      )}
    </Stack>
  )}
</Grid.Col>
```

**What to avoid:**
- Don't show both views simultaneously (waste of space, user won't compare)
- Don't use tabs instead of SegmentedControl (SegmentedControl is Mantine standard for view toggles per Phase 11)
- Don't create separate route for heatmap (same data, just different visualization)
  </action>
  <verify>
Manual check:
1. Navigate to /correlation
2. Select variables and compute correlations
3. Toggle between "Network Graph" and "Heatmap Matrix"
4. Verify both views render correctly
5. Verify heatmap scrolls horizontally if matrix is large
  </verify>
  <done>
- CorrelationAnalysis page updated with view toggle
- SegmentedControl for switching between graph and heatmap
- Both views use same correlation data
- Heatmap integrated alongside existing Reagraph network graph
- Consistent with Phase 11 metric toggle pattern (SegmentedControl fullWidth)
- No layout shift when toggling views
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Enhanced data visualization components:
1. **CorrelationHeatmap** - CSS Grid matrix with color-coded cells (red=negative, blue=positive)
2. **RiskEventTimeline** - Recharts ComposedChart combining risk line with event scatter markers
3. **Correlation page enhancements** - SegmentedControl toggle between network graph and heatmap views

All built using existing Recharts/Mantine patterns (no new dependencies).
  </what-built>
  <how-to-verify>
1. **Start services:**
   ```bash
   # Terminal 1 - Backend
   cd backend && python manage.py runserver

   # Terminal 2 - Frontend
   cd frontend && npm run dev
   ```

2. **Test correlation heatmap:**
   - Visit: http://localhost:5173/correlation
   - Select 3+ variables (e.g., "WTI Oil Price", "PDVSA Risk", "Sanctions Events")
   - Click "Compute Correlations"
   - Toggle to "Heatmap Matrix" view
   - Verify:
     - Grid displays with variables as rows/columns
     - Cells show correlation values (-1.00 to +1.00)
     - Cell colors: red (negative), blue (positive), white (neutral)
     - Diagonal cells show 1.00 (self-correlation)
     - Hover tooltip shows full variable names and r-value
     - Legend gradient shows color scale
     - Horizontal scroll works for large matrices

3. **Test view toggle:**
   - Switch between "Network Graph" and "Heatmap Matrix"
   - Verify both views use same data
   - Verify no layout shift or errors when toggling
   - Verify SegmentedControl highlights active view

4. **Test timeline visualization (if backend has event data):**
   - Navigate to entity profile or dashboard page
   - Check if RiskEventTimeline component used anywhere
   - Verify risk line renders smoothly
   - Verify event markers (red dots) appear on days with events
   - Hover over markers to see event details in tooltip
   - Verify tooltip shows event type badges with severity colors

5. **Visual quality:**
   - Heatmap cells have proper spacing (1px gap)
   - Colors match design tokens
   - Text is readable in all cells
   - Responsive layout works on mobile (horizontal scroll)
   - No console errors

6. **Edge cases:**
   - Only 2 variables selected → 2×2 heatmap matrix
   - 10+ variables → matrix scrolls horizontally
   - No significant correlations → heatmap shows mostly gray/white cells
   - Toggle views multiple times → no memory leaks or errors
  </how-to-verify>
  <resume-signal>Type "approved" if visualizations work correctly, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] CorrelationHeatmap component renders CSS Grid matrix
- [ ] RiskEventTimeline component created with ComposedChart
- [ ] Correlation page has view toggle (graph vs heatmap)
- [ ] Heatmap colors match correlation values (red/blue scale)
- [ ] Timeline shows risk line with event scatter overlay
- [ ] Custom tooltip on timeline shows event details
- [ ] Horizontal scroll works for large heatmaps
- [ ] SegmentedControl toggle works smoothly
- [ ] No new dependencies added
- [ ] No TypeScript errors
- [ ] Design tokens used consistently
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- CorrelationHeatmap component with CSS Grid (no new libraries)
- RiskEventTimeline component with Recharts ComposedChart
- Correlation page enhanced with heatmap view toggle
- Color scales use design tokens
- Responsive layouts maintain established patterns
- Human verification approved
- No errors or warnings introduced
- Phase 16 complete (enhanced data visualization)
</success_criteria>

<output>
After completion, create `.planning/phases/16-enhanced-data-visualization/16-01-SUMMARY.md`:

# Phase 16 Plan 01: Enhanced Data Visualization Summary

**Expanded visualization toolkit: heatmaps, timelines, and comparison views using existing Recharts/Mantine patterns.**

## Accomplishments

- Created CorrelationHeatmap component with CSS Grid layout (no new dependencies)
- Created RiskEventTimeline component combining line chart with event markers
- Enhanced correlation analysis page with graph/heatmap view toggle
- Implemented color scale for correlation strength (red=negative, blue=positive)
- Added custom tooltips for event details on timeline
- Applied design tokens consistently across all new visualizations
- Maintained responsive patterns established in Phases 10-13

## Files Created/Modified

- `frontend/src/components/charts/CorrelationHeatmap.tsx` - Correlation matrix heatmap
- `frontend/src/components/charts/CorrelationHeatmap.module.css` - Heatmap styles
- `frontend/src/components/charts/RiskEventTimeline.tsx` - Risk+event combo chart
- `frontend/src/pages/CorrelationAnalysis.tsx` - Added heatmap view toggle

## Decisions Made

- Used CSS Grid for heatmap (not D3, Nivo, or Victory - avoids new dependencies)
- Color scale from rgba red/blue with alpha for intensity (consistent with design tokens)
- SegmentedControl for view toggle (established pattern from Phase 11)
- ComposedChart for timeline (established pattern from EntityForecastChart Phase 14)
- Scatter plot for event markers (cleaner than bar chart overlay)
- Custom tooltip for timeline to show event details (default tooltip insufficient)
- Horizontal scroll for large heatmaps (better than zoom/pan complexity)

## Issues Encountered

None

## Next Phase Readiness

Phase 16 (Enhanced Data Visualization) is **COMPLETE**:
- Heatmap visualization for correlation matrices
- Timeline visualization combining risk scores with event markers
- View toggle pattern for alternative visualizations
- All using existing Recharts/Mantine patterns (zero new dependencies)

v1.2 Advanced Analytics milestone nearing completion. Next up: Phase 18 (GCP-Native Pipeline Migration) or revisit Phase 15 if additional correlation analysis needed.

---

*Phase: 16-enhanced-data-visualization*
*Plan: 01 of 01*
*Completed: [execution date]*
</output>
